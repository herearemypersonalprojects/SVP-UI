<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Diễn đàn Sinh viên & Tri thức Việt tại Pháp (SVP)</title>
    <link rel="icon" type="image/svg+xml" href="assets/icons/favicon.svg">
    <link rel="shortcut icon" href="assets/icons/favicon.svg">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:ital,wght@1,700&family=Roboto+Condensed:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="svp.css">
    <link rel="stylesheet" href="dropdown-hover.css">
    <style>
        .sv-forum-toolbar {
            border: 1px solid var(--sv-border);
            border-radius: 12px;
            background: #fff;
            padding: .9rem;
        }
        .sv-forum-grid-head,
        .sv-forum-row {
            display: grid;
            grid-template-columns: minmax(280px, 1.8fr) minmax(130px, .9fr) minmax(110px, .7fr) minmax(120px, .8fr);
            gap: .75rem;
            align-items: center;
        }
        .sv-forum-grid-head {
            padding: .7rem 1rem;
            color: #334155;
            font-size: .82rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: .04em;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        .sv-forum-row {
            padding: .9rem 1rem;
            border-bottom: 1px dashed #e2e8f0;
            text-decoration: none;
            color: inherit;
        }
        .sv-forum-row:hover {
            background: #f8fbff;
        }
        .sv-forum-row:last-child {
            border-bottom: 0;
        }
        .sv-forum-topic__title {
            color: #0f172a;
            font-weight: 800;
            line-height: 1.3;
            margin-bottom: .25rem;
        }
        .sv-forum-topic__meta {
            color: #64748b;
            font-size: .85rem;
            margin-bottom: .3rem;
        }
        .sv-forum-topic__excerpt {
            color: #475569;
            font-size: .88rem;
            line-height: 1.45;
        }
        .sv-forum-count {
            text-align: right;
            color: #475569;
            font-size: .85rem;
            line-height: 1.35;
        }
        .sv-forum-last {
            color: #334155;
            font-size: .86rem;
        }
        .sv-forum-last .sv-meta {
            font-size: .8rem;
        }
        .sv-forum-pagination {
            display: flex;
            gap: .4rem;
            flex-wrap: wrap;
            justify-content: center;
            padding: .9rem;
            border-top: 1px dashed #edf2f7;
        }
        .sv-forum-empty {
            padding: 1.4rem 1rem;
            text-align: center;
            color: #64748b;
        }
        .sv-kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: .6rem;
        }
        .sv-kpi {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: .65rem .7rem;
            background: #f8fafc;
        }
        .sv-kpi__label {
            color: #64748b;
            font-size: .78rem;
            text-transform: uppercase;
            letter-spacing: .05em;
            margin-bottom: .15rem;
        }
        .sv-kpi__value {
            color: #0f172a;
            font-weight: 800;
            font-size: 1rem;
        }
        @media (max-width: 991px) {
            .sv-forum-grid-head,
            .sv-forum-row {
                grid-template-columns: 1fr;
                gap: .5rem;
            }
            .sv-forum-grid-head {
                display: none;
            }
            .sv-forum-count {
                text-align: left;
            }
        }
    </style>
</head>
<body>

<div class="sv-topbar pt-2 pb-1">
    <div class="container d-flex align-items-center justify-content-between">
        <div class="sv-brand">
            <img class="sv-brand__logo-img" src="assets/icons/logo_svp.png" alt="SVP" width="102" height="112" />
            <div class="sv-brand__title">
                <h1>DIỄN ĐÀN SINH VIÊN & TRI THỨC VIỆT TẠI PHÁP <span class="sv-brand__accent">(SVP)</span></h1>
                <div class="sv-brand__divider"></div>
                <small class="sv-brand__tagline">Kết Nối – Chia Sẻ – Thành Công</small>
            </div>
        </div>

        <div id="sv-auth-box" class="sv-auth d-none d-md-flex align-items-center gap-2">
            <a class="btn btn-outline-secondary" href="signup.html">Đăng Ký</a>
            <a class="btn btn-primary" href="login.html">Đăng Nhập</a>
        </div>
    </div>
</div>

<div class="sv-nav">
    <div class="container d-flex align-items-center justify-content-between">
        <ul class="nav">
            <li class="nav-item"><a class="nav-link" href="index.html">Trang Chủ</a></li>
            <li class="nav-item"><a class="nav-link active" href="forum.html">Diễn Đàn</a></li>
            <li class="nav-item"><a class="nav-link" href="categories.html">Khám Phá Chủ Đề</a></li>
            <li class="nav-item"><a class="nav-link" href="events.html">Sự Kiện & Lễ Hội</a></li>
            <li class="nav-item"><a class="nav-link" href="ban-do-paris.html">Bản Đồ Paris</a></li>
            <li class="nav-item"><a class="nav-link" href="about.html">Giới Thiệu</a></li>
        </ul>

        <div class="sv-search position-relative my-2 my-md-0" style="width:min(320px, 60vw);">
            <i class="fa fa-magnifying-glass"></i>
            <input class="form-control" type="search" placeholder="Tìm kiếm..." />
        </div>
    </div>
</div>

<main class="container my-3 my-md-4">
    <div class="sv-breadcrumb">
        <a href="index.html">Trang chủ</a> / <span>Diễn đàn</span>
    </div>

    <section class="sv-page-hero mb-3">
        <div class="sv-page-hero__eyebrow">Việt tại Pháp</div>
        <h2 class="sv-page-hero__title">Diễn Đàn SVP</h2>
        <p class="sv-page-hero__subtitle">Không gian thảo luận chính thức của SVP, cập nhật theo thời gian thực.</p>
        <div class="sv-page-hero__actions">
            <a class="btn btn-primary" href="create_new_discussion.html"><i class="fa-solid fa-pen-to-square me-2"></i>Tạo chủ đề mới</a>
            <a class="btn btn-outline-secondary" href="categories.html"><i class="fa-solid fa-layer-group me-2"></i>Xem chuyên mục</a>
        </div>
    </section>

    <div class="row g-3">
        <div class="col-lg-8">
            <section class="sv-forum-toolbar mb-3">
                <div class="row g-2">
                    <div class="col-md-5">
                        <label for="forum-search" class="form-label mb-1">Từ khóa</label>
                        <input id="forum-search" class="form-control" type="search" placeholder="Tìm theo tiêu đề, tác giả, nội dung...">
                    </div>
                    <div class="col-md-4">
                        <label for="forum-category" class="form-label mb-1">Chuyên mục</label>
                        <select id="forum-category" class="form-select"></select>
                    </div>
                    <div class="col-md-3">
                        <label for="forum-sort" class="form-label mb-1">Sắp xếp</label>
                        <select id="forum-sort" class="form-select">
                            <option value="newest">Mới nhất</option>
                            <option value="oldest">Cũ nhất</option>
                            <option value="popular">Phổ biến</option>
                            <option value="title">A → Z</option>
                        </select>
                    </div>
                </div>
            </section>

            <section class="sv-card">
                <div class="sv-card__hd d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <span><i class="fa-solid fa-comments me-2 text-primary"></i>Danh sách chủ đề</span>
                    <span id="forum-count" class="sv-meta">Đang tải...</span>
                </div>
                <div class="sv-forum-grid-head">
                    <div>Chủ đề</div>
                    <div>Chuyên mục</div>
                    <div>Phản hồi / Xem</div>
                    <div>Hoạt động cuối</div>
                </div>
                <div id="forum-thread-list"></div>
                <div id="forum-pagination" class="sv-forum-pagination"></div>
            </section>
        </div>

        <div class="col-lg-4">
            <section class="sv-card mb-3">
                <div class="sv-card__hd"><i class="fa-solid fa-chart-simple me-2 text-primary"></i>Tổng quan diễn đàn</div>
                <div class="p-3">
                    <div id="forum-kpis" class="sv-kpi-grid"></div>
                </div>
            </section>

            <section class="sv-card mb-3">
                <div class="sv-card__hd"><i class="fa-solid fa-fire-flame-curved me-2 text-primary"></i>Chủ đề nổi bật</div>
                <ul id="forum-trending" class="sv-list mb-0"></ul>
            </section>

            <section class="sv-card">
                <div class="sv-card__hd"><i class="fa-solid fa-layer-group me-2 text-primary"></i>Phân bố chuyên mục</div>
                <ul id="forum-category-stats" class="sv-list mb-0"></ul>
            </section>
        </div>
    </div>
</main>

<footer class="container py-4">
    <div class="row">
        <div class="col-md">
            <div class="sv-brand d-flex align-items-center mb-2">
                <div class="sv-brand__logo" style="width:36px; height:36px; font-size:14px;">SVP</div>
                <strong class="ms-2">SVP - Kết Nối • Chia Sẻ • Thành Công</strong>
            </div>
            <div>© 2026 SVP. Mọi quyền được bảo lưu.</div>
        </div>
        <div class="col-md text-md-end mt-2 mt-md-0">
            <a class="me-3" href="terms.html">Điều khoản</a>
            <a class="me-3" href="security.html">Bảo mật</a>
            <a href="contact.html">Liên hệ</a>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function () {
        const API_BASE_URL = window.SVP_API_BASE_URL || 'http://localhost:8080';
        const PAGE_SIZE = 10;
        const METRIC_KEY = 'svp.forum.thread.metrics.v1';

        const CATEGORY_MAP = new Map([
            [1, 'Học tập và nghiên cứu tại Pháp'],
            [2, 'Kinh nghiệm xin học bổng và du học'],
            [3, 'Cuộc sống tại Pháp'],
            [4, 'Cơ hội việc làm và thực tập'],
            [5, 'Pháp lý, quốc tịch và thuế khóa'],
            [6, 'Văn hóa và ngôn ngữ Pháp'],
            [7, 'Sự kiện và giao lưu'],
            [8, 'Nhà cửa'],
            [9, 'Mua bán, rao vặt'],
            [10, 'Đầu tư tại Pháp'],
            [11, 'Trải nghiệm cá nhân'],
            [12, 'Công nghệ và kỹ năng'],
            [13, 'Giải trí, du lịch'],
            [14, 'Văn học và nghệ thuật'],
            [15, 'Gặp gỡ, hẹn hò'],
            [16, 'Chém gió, tán gẫu'],
            [17, 'Góp ý xây dựng SVP']
        ]);

        const FALLBACK_THREADS = [
            {
                threadId: 9001,
                title: 'Checklist hồ sơ CAF cho tân du học sinh',
                categoryId: 3,
                categoryName: 'Cuộc sống tại Pháp',
                authorName: 'SVP Admin',
                createdAt: '2026-02-14T08:30:00Z',
                excerpt: 'Tổng hợp giấy tờ và mốc thời gian quan trọng khi làm CAF, bao gồm lưu ý scan hồ sơ và cách theo dõi phản hồi.'
            },
            {
                threadId: 9002,
                title: 'Mẫu CV tiếng Pháp cho internship ngành IT',
                categoryId: 4,
                categoryName: 'Cơ hội việc làm và thực tập',
                authorName: 'SVP Career Team',
                createdAt: '2026-02-10T11:45:00Z',
                excerpt: 'Bài chia sẻ cấu trúc CV, các mục bắt buộc và lỗi thường gặp khiến hồ sơ bị loại sớm.'
            },
            {
                threadId: 9003,
                title: 'Kinh nghiệm tìm nhà khu vực ngoại ô Paris',
                categoryId: 8,
                categoryName: 'Nhà cửa',
                authorName: 'Ngọc Hà',
                createdAt: '2026-02-08T16:20:00Z',
                excerpt: 'So sánh ưu nhược điểm từng khu vực, kinh nghiệm đi xem nhà và cách tránh lừa đảo khi đặt cọc.'
            }
        ];

        const listEl = document.getElementById('forum-thread-list');
        const paginationEl = document.getElementById('forum-pagination');
        const countEl = document.getElementById('forum-count');
        const searchEl = document.getElementById('forum-search');
        const categoryEl = document.getElementById('forum-category');
        const sortEl = document.getElementById('forum-sort');
        const kpisEl = document.getElementById('forum-kpis');
        const trendingEl = document.getElementById('forum-trending');
        const categoryStatsEl = document.getElementById('forum-category-stats');

        if (!listEl || !paginationEl || !countEl || !searchEl || !categoryEl || !sortEl || !kpisEl || !trendingEl || !categoryStatsEl) {
            return;
        }

        const params = new URLSearchParams(window.location.search);
        const VALID_SORTS = new Set(['newest', 'oldest', 'popular', 'title']);
        const state = {
            threads: [],
            sourceLabel: 'API',
            query: params.get('q') || '',
            category: params.get('category') || 'all',
            sort: params.get('sort') || 'newest',
            page: Math.max(1, Number(params.get('page') || 1) || 1)
        };
        if (!VALID_SORTS.has(state.sort)) {
            state.sort = 'newest';
        }
        if (state.category !== 'all' && !CATEGORY_MAP.has(Number(state.category))) {
            state.category = 'all';
        }

        const escapeHtml = (value) => String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');

        const stripHtml = (html) => String(html || '')
            .replace(/<\s*br\s*\/?\s*>/gi, '\n')
            .replace(/<\s*\/\s*(p|div|h[1-6]|li|blockquote)\s*>/gi, '\n')
            .replace(/<[^>]+>/g, ' ')
            .replace(/&nbsp;/gi, ' ')
            .replace(/\s+/g, ' ')
            .trim();

        const excerptFromHtml = (html, maxLen) => {
            const plain = stripHtml(html);
            if (plain.length <= maxLen) {
                return plain;
            }
            return `${plain.slice(0, maxLen - 1).trim()}...`;
        };

        const toMillis = (value) => {
            const time = Date.parse(String(value || ''));
            return Number.isFinite(time) ? time : 0;
        };

        const formatDateTime = (value) => {
            const time = toMillis(value);
            if (!time) return 'Không rõ thời gian';
            return new Intl.DateTimeFormat('vi-VN', {
                dateStyle: 'short',
                timeStyle: 'short'
            }).format(new Date(time));
        };

        const timeAgo = (value) => {
            const time = toMillis(value);
            if (!time) return 'Không rõ';
            const diffMinutes = Math.max(0, Math.floor((Date.now() - time) / 60000));
            if (diffMinutes < 1) return 'Vừa xong';
            if (diffMinutes < 60) return `${diffMinutes} phút trước`;
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours} giờ trước`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays} ngày trước`;
        };

        const loadMetricStore = () => {
            try {
                const parsed = JSON.parse(localStorage.getItem(METRIC_KEY) || '{}');
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch (_) {
                return {};
            }
        };

        const metricStore = loadMetricStore();

        const getMetrics = (threadId) => {
            const key = String(threadId);
            const raw = metricStore[key] && typeof metricStore[key] === 'object' ? metricStore[key] : {};
            const replies = Number(raw.replies || 0);
            const views = Number(raw.views || 0);
            const lastCommentAt = raw.lastCommentAt ? String(raw.lastCommentAt) : '';
            return {
                replies: Number.isFinite(replies) && replies >= 0 ? Math.floor(replies) : 0,
                views: Number.isFinite(views) && views >= 0 ? Math.floor(views) : 0,
                lastCommentAt
            };
        };

        const popularScore = (thread) => {
            const metrics = getMetrics(thread.threadId);
            const recency = toMillis(thread.createdAt) ? Math.max(0, (Date.now() - toMillis(thread.createdAt)) / 3600000) : 999;
            const freshnessBoost = recency < 72 ? (72 - recency) / 6 : 0;
            return metrics.replies * 5 + metrics.views + freshnessBoost;
        };

        const normalizeApiThread = (post) => {
            const categoryId = Number(post?.categoryId || 0);
            const categoryName = CATEGORY_MAP.get(categoryId) || `Chuyên mục #${categoryId || '?'}`;
            const author = post?.author || {};
            const authorName = String(author.displayName || author.nickname || 'Thành viên SVP');
            return {
                threadId: Number(post?.postId || 0),
                title: String(post?.title || 'Chủ đề mới'),
                categoryId,
                categoryName,
                authorName,
                createdAt: String(post?.createdAt || ''),
                excerpt: excerptFromHtml(post?.contentHtml || '', 180)
            };
        };

        const buildCategorySelect = () => {
            const options = ['<option value="all">Tất cả chuyên mục</option>'];
            Array.from(CATEGORY_MAP.entries())
                .sort((a, b) => a[0] - b[0])
                .forEach(([id, label]) => {
                    options.push(`<option value="${id}">${id}. ${escapeHtml(label)}</option>`);
                });
            categoryEl.innerHTML = options.join('');
        };

        const mergeLocalDraft = (threads) => threads;

        const fetchThreads = async () => {
            const response = await fetch(`${API_BASE_URL}/posts/latest-discussions?limit=200`, {
                method: 'GET',
                headers: { Accept: 'application/json' }
            });
            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
                throw new Error(payload.error || 'Không thể tải danh sách chủ đề.');
            }
            const items = Array.isArray(payload.items) ? payload.items.map(normalizeApiThread) : [];
            return items.filter((item) => item.threadId > 0);
        };

        const syncUrlState = () => {
            const next = new URLSearchParams();
            if (state.query.trim()) next.set('q', state.query.trim());
            if (state.category !== 'all') next.set('category', state.category);
            if (state.sort !== 'newest') next.set('sort', state.sort);
            if (state.page > 1) next.set('page', String(state.page));
            const query = next.toString();
            const nextUrl = query ? `${window.location.pathname}?${query}` : window.location.pathname;
            window.history.replaceState({}, '', nextUrl);
        };

        const syncControls = () => {
            searchEl.value = state.query;
            categoryEl.value = state.category;
            sortEl.value = state.sort;
        };

        const filterThreads = () => {
            const query = state.query.trim().toLowerCase();
            return state.threads.filter((thread) => {
                const categoryPass = state.category === 'all' || String(thread.categoryId) === state.category;
                if (!categoryPass) return false;
                if (!query) return true;
                const haystack = `${thread.title} ${thread.authorName} ${thread.excerpt} ${thread.categoryName}`.toLowerCase();
                return haystack.includes(query);
            });
        };

        const sortThreads = (threads) => {
            const sorted = [...threads];
            switch (state.sort) {
                case 'oldest':
                    sorted.sort((a, b) => toMillis(a.createdAt) - toMillis(b.createdAt));
                    break;
                case 'popular':
                    sorted.sort((a, b) => popularScore(b) - popularScore(a));
                    break;
                case 'title':
                    sorted.sort((a, b) => a.title.localeCompare(b.title, 'vi'));
                    break;
                case 'newest':
                default:
                    sorted.sort((a, b) => toMillis(b.createdAt) - toMillis(a.createdAt));
                    break;
            }
            return sorted;
        };

        const renderList = (items) => {
            if (!items.length) {
                listEl.innerHTML = '<div class="sv-forum-empty">Không tìm thấy chủ đề phù hợp với bộ lọc hiện tại.</div>';
                return;
            }

            listEl.innerHTML = items.map((thread) => {
                const metrics = getMetrics(thread.threadId);
                const lastActive = metrics.lastCommentAt || thread.createdAt;
                return `
                    <a class="sv-forum-row" href="thread.html?postId=${encodeURIComponent(thread.threadId)}">
                        <div class="sv-forum-topic">
                            <div class="sv-forum-topic__title">${escapeHtml(thread.title)}</div>
                            <div class="sv-forum-topic__meta">Tạo bởi <strong>${escapeHtml(thread.authorName)}</strong> • ${escapeHtml(formatDateTime(thread.createdAt))}</div>
                            <div class="sv-forum-topic__excerpt">${escapeHtml(thread.excerpt || 'Nội dung chi tiết trong thread...')}</div>
                        </div>
                        <div><span class="sv-tag">${escapeHtml(thread.categoryName)}</span></div>
                        <div class="sv-forum-count"><strong>${metrics.replies}</strong> phản hồi<br><strong>${metrics.views}</strong> lượt xem</div>
                        <div class="sv-forum-last">
                            <div>${escapeHtml(timeAgo(lastActive))}</div>
                            <div class="sv-meta">${escapeHtml(formatDateTime(lastActive))}</div>
                        </div>
                    </a>
                `;
            }).join('');
        };

        const renderPagination = (totalItems) => {
            const totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));
            state.page = Math.min(Math.max(1, state.page), totalPages);

            if (totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            const buttons = [];
            buttons.push(`<button class="btn btn-sm btn-outline-secondary" data-page="prev" ${state.page === 1 ? 'disabled' : ''}>Trước</button>`);
            for (let i = 1; i <= totalPages; i += 1) {
                buttons.push(`<button class="btn btn-sm ${i === state.page ? 'btn-primary' : 'btn-outline-secondary'}" data-page="${i}">${i}</button>`);
            }
            buttons.push(`<button class="btn btn-sm btn-outline-secondary" data-page="next" ${state.page === totalPages ? 'disabled' : ''}>Sau</button>`);
            paginationEl.innerHTML = buttons.join('');
        };

        const renderRightPanels = (threads) => {
            const totalThreads = threads.length;
            const totalReplies = threads.reduce((sum, thread) => sum + getMetrics(thread.threadId).replies, 0);
            const totalViews = threads.reduce((sum, thread) => sum + getMetrics(thread.threadId).views, 0);
            const latestTime = threads.reduce((max, thread) => Math.max(max, toMillis(thread.createdAt)), 0);

            kpisEl.innerHTML = `
                <div class="sv-kpi"><div class="sv-kpi__label">Nguồn dữ liệu</div><div class="sv-kpi__value">${escapeHtml(state.sourceLabel)}</div></div>
                <div class="sv-kpi"><div class="sv-kpi__label">Tổng chủ đề</div><div class="sv-kpi__value">${totalThreads}</div></div>
                <div class="sv-kpi"><div class="sv-kpi__label">Tổng phản hồi</div><div class="sv-kpi__value">${totalReplies}</div></div>
                <div class="sv-kpi"><div class="sv-kpi__label">Tổng lượt xem</div><div class="sv-kpi__value">${totalViews}</div></div>
                <div class="sv-kpi" style="grid-column:1 / -1;"><div class="sv-kpi__label">Hoạt động gần nhất</div><div class="sv-kpi__value" style="font-size:.95rem;">${escapeHtml(latestTime ? formatDateTime(latestTime) : 'Chưa có dữ liệu')}</div></div>
            `;

            const trending = [...threads]
                .sort((a, b) => popularScore(b) - popularScore(a))
                .slice(0, 5);
            if (!trending.length) {
                trendingEl.innerHTML = '<li><div class="sv-meta">Chưa có chủ đề nổi bật.</div></li>';
            } else {
                trendingEl.innerHTML = trending.map((thread) => {
                    const metrics = getMetrics(thread.threadId);
                    return `
                        <li>
                            <div>
                                <a href="thread.html?postId=${encodeURIComponent(thread.threadId)}">${escapeHtml(thread.title)}</a>
                                <div class="sv-meta">${metrics.replies} phản hồi • ${metrics.views} lượt xem</div>
                            </div>
                            <span class="sv-badge">Hot</span>
                        </li>
                    `;
                }).join('');
            }

            const categoryCounter = new Map();
            threads.forEach((thread) => {
                const current = categoryCounter.get(thread.categoryName) || 0;
                categoryCounter.set(thread.categoryName, current + 1);
            });
            const categoryRows = Array.from(categoryCounter.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            if (!categoryRows.length) {
                categoryStatsEl.innerHTML = '<li><div class="sv-meta">Chưa có dữ liệu chuyên mục.</div></li>';
            } else {
                categoryStatsEl.innerHTML = categoryRows.map(([name, count]) => `
                    <li>
                        <div>
                            <span>${escapeHtml(name)}</span>
                            <div class="sv-meta">${count} chủ đề</div>
                        </div>
                        <span class="sv-badge">${count}</span>
                    </li>
                `).join('');
            }
        };

        const render = () => {
            const filtered = sortThreads(filterThreads());
            const totalItems = filtered.length;
            const totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));
            state.page = Math.min(Math.max(1, state.page), totalPages);

            const start = (state.page - 1) * PAGE_SIZE;
            const pageItems = filtered.slice(start, start + PAGE_SIZE);

            countEl.textContent = `${totalItems} chủ đề`;
            renderList(pageItems);
            renderPagination(totalItems);
            renderRightPanels(filtered);
            syncUrlState();
        };

        const bindEvents = () => {
            searchEl.addEventListener('input', (event) => {
                state.query = String(event.target.value || '');
                state.page = 1;
                render();
            });

            categoryEl.addEventListener('change', (event) => {
                state.category = String(event.target.value || 'all');
                state.page = 1;
                render();
            });

            sortEl.addEventListener('change', (event) => {
                state.sort = String(event.target.value || 'newest');
                state.page = 1;
                render();
            });

            paginationEl.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLButtonElement)) return;
                const pageToken = String(target.dataset.page || '');
                if (!pageToken) return;

                const filteredCount = filterThreads().length;
                const totalPages = Math.max(1, Math.ceil(filteredCount / PAGE_SIZE));
                if (pageToken === 'prev') {
                    state.page = Math.max(1, state.page - 1);
                } else if (pageToken === 'next') {
                    state.page = Math.min(totalPages, state.page + 1);
                } else {
                    const next = Number(pageToken);
                    if (Number.isInteger(next) && next > 0) {
                        state.page = Math.min(totalPages, next);
                    }
                }
                render();
            });
        };

        const load = async () => {
            buildCategorySelect();
            syncControls();
            listEl.innerHTML = '<div class="sv-forum-empty">Đang tải dữ liệu forum...</div>';
            try {
                const apiThreads = await fetchThreads();
                state.threads = mergeLocalDraft(apiThreads);
                state.sourceLabel = 'API';
                if (!state.threads.length) {
                    state.threads = FALLBACK_THREADS;
                    state.sourceLabel = 'Fallback';
                }
            } catch (error) {
                console.error('Cannot load forum threads:', error);
                state.threads = mergeLocalDraft(FALLBACK_THREADS);
                state.sourceLabel = 'Fallback';
            }
            bindEvents();
            render();
        };

        load();
    })();
</script>
<script src="auth-topbar.js"></script>
</body>
</html>


