<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chi tiết sự kiện - SVP</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="svp.css">
    <style>
        .sv-event-hero {
            width: 100%;
            aspect-ratio: 16 / 7;
            border-radius: 14px;
            border: 1px solid #dbeafe;
            background: linear-gradient(120deg, #dbeafe, #bfdbfe);
            background-size: cover;
            background-position: center;
            margin-bottom: 1rem;
        }
        .sv-event-meta-list {
            display: grid;
            gap: .6rem;
        }
        .sv-event-meta-item {
            display: flex;
            align-items: center;
            gap: .55rem;
            color: #334155;
        }
        .sv-event-content {
            color: #0f172a;
            line-height: 1.7;
            white-space: normal;
            word-break: break-word;
        }
    </style>
</head>
<body>
<div class="sv-topbar pt-2 pb-1">
    <div class="container d-flex align-items-center justify-content-between">
        <div class="sv-brand">
            <img class="sv-brand__logo-img" src="assets/icons/logo_svp.png" alt="SVP" width="102" height="112" />
            <div class="sv-brand__title">
                <h1>DIỄN ĐÀN SINH VIÊN & TRI THỨC VIỆT TẠI PHÁP <span class="sv-brand__accent">(SVP)</span></h1>
                <div class="sv-brand__divider"></div>
                <small class="sv-brand__tagline">Kết Nối – Chia Sẻ – Thành Công</small>
            </div>
        </div>

        <div id="sv-auth-box" class="sv-auth d-none d-md-flex align-items-center gap-2">
            <a class="btn btn-outline-secondary" href="signup.html">Đăng Ký</a>
            <a class="btn btn-primary" href="login.html">Đăng Nhập</a>
        </div>
    </div>
</div>

<div class="sv-nav">
    <div class="container d-flex align-items-center justify-content-between">
        <ul class="nav">
            <li class="nav-item"><a class="nav-link" href="index.html">Trang Chủ</a></li>
            <li class="nav-item"><a class="nav-link" href="forum.html">Diễn Đàn</a></li>
            <li class="nav-item"><a class="nav-link" href="categories.html">Khám Phá Chủ Đề</a></li>
            <li class="nav-item"><a class="nav-link active" href="events.html">Sự Kiện & Lễ Hội</a></li>
            <li class="nav-item"><a class="nav-link" href="ban-do-paris.html">Bản Đồ Paris</a></li>
            <li class="nav-item"><a class="nav-link" href="about.html">Giới Thiệu</a></li>
        </ul>
    </div>
</div>

<main class="container my-3 my-md-4">
    <div class="sv-breadcrumb mb-3">
        <a href="index.html">Trang chủ</a> / <a href="events.html">Sự kiện</a> / <span>Chi tiết sự kiện</span>
    </div>

    <section class="sv-card">
        <div class="sv-card__hd d-flex justify-content-between align-items-center gap-2">
            <span><i class="fa-solid fa-calendar-day me-2 text-primary"></i>Chi tiết sự kiện</span>
            <a class="btn btn-sm btn-outline-primary" href="events.html">Quay lại danh sách</a>
        </div>
        <div class="p-3 p-md-4">
            <div id="event-detail-loading" class="sv-meta">Đang tải thông tin sự kiện...</div>
            <div id="event-detail-error" class="alert alert-danger d-none" role="alert"></div>
            <article id="event-detail-body" class="d-none">
                <div id="event-detail-hero" class="sv-event-hero"></div>
                <h2 id="event-detail-title" class="mb-3">Sự kiện</h2>
                <div class="sv-event-meta-list mb-3">
                    <div class="sv-event-meta-item"><i class="fa-regular fa-clock text-primary"></i><span id="event-detail-time"></span></div>
                    <div class="sv-event-meta-item"><i class="fa-solid fa-location-dot text-primary"></i><span id="event-detail-address"></span></div>
                    <div class="sv-event-meta-item"><i class="fa-solid fa-ticket text-primary"></i><span id="event-detail-price"></span></div>
                    <div class="sv-event-meta-item"><i class="fa-regular fa-user text-primary"></i><span id="event-detail-host"></span></div>
                </div>
                <div id="event-detail-content" class="sv-event-content"></div>
            </article>
        </div>
    </section>
</main>

<footer class="container py-4">
    <div class="row">
        <div class="col-md">
            <div class="sv-brand d-flex align-items-center mb-2">
                <div class="sv-brand__logo" style="width:36px; height:36px; font-size:14px;">SVP</div>
                <strong class="ms-2">SVP - Kết Nối • Chia Sẻ • Thành Công</strong>
            </div>
            <div>© 2026 SVP. Mọi quyền được bảo lưu.</div>
        </div>
        <div class="col-md text-md-end mt-2 mt-md-0">
            <a class="me-3" href="terms.html">Điều khoản</a>
            <a class="me-3" href="security.html">Bảo mật</a>
            <a href="contact.html">Liên hệ</a>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="auth-topbar.js"></script>
<script>
    (function () {
        const API_BASE_URL = window.SVP_API_BASE_URL || 'http://localhost:8080';
        const loadingEl = document.getElementById('event-detail-loading');
        const errorEl = document.getElementById('event-detail-error');
        const bodyEl = document.getElementById('event-detail-body');
        const heroEl = document.getElementById('event-detail-hero');
        const titleEl = document.getElementById('event-detail-title');
        const timeEl = document.getElementById('event-detail-time');
        const addressEl = document.getElementById('event-detail-address');
        const priceEl = document.getElementById('event-detail-price');
        const hostEl = document.getElementById('event-detail-host');
        const contentEl = document.getElementById('event-detail-content');

        if (!loadingEl || !errorEl || !bodyEl || !heroEl || !titleEl || !timeEl || !addressEl || !priceEl || !hostEl || !contentEl) {
            return;
        }

        const params = new URLSearchParams(window.location.search);
        const rawEventId = (params.get('eventId') || '').trim();
        const eventId = Number(rawEventId);

        const escapeHtml = (value) => String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');

        const formatDateTime = (value) => {
            if (!value) return 'Chưa cập nhật';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return String(value);
            }
            return new Intl.DateTimeFormat('vi-VN', {
                dateStyle: 'full',
                timeStyle: 'short'
            }).format(date);
        };

        const toPriceLabel = (rawPrice, online) => {
            const price = Number(rawPrice);
            if (Number.isFinite(price) && price > 0) {
                return `${price.toLocaleString('vi-VN')}€`;
            }
            return online ? 'Online / Miễn phí' : 'Miễn phí';
        };

        const toAddressLabel = (online, address) => {
            const safeAddress = String(address || '').trim();
            if (online && safeAddress.length === 0) {
                return 'Online';
            }
            return safeAddress || 'Địa điểm sẽ cập nhật';
        };

        const toContentHtml = (content) => {
            const safeText = escapeHtml(content || 'Nội dung sự kiện đang được cập nhật.');
            return safeText.replace(/\n/g, '<br>');
        };

        const renderDetail = (payload) => {
            const event = payload && payload.event && typeof payload.event === 'object' ? payload.event : payload;
            const title = String(event.title || 'Sự kiện');
            const organizer = event.organizer || {};
            const hostName = String(organizer.displayName || organizer.nickname || 'Ban tổ chức SVP');
            const imageUrl = String(event.imageUrl || '').trim();

            titleEl.textContent = title;
            timeEl.textContent = formatDateTime(event.eventTime);
            addressEl.textContent = toAddressLabel(Boolean(event.online), event.address);
            priceEl.textContent = toPriceLabel(event.price, Boolean(event.online));
            hostEl.textContent = hostName;
            contentEl.innerHTML = toContentHtml(event.content);

            if (imageUrl) {
                heroEl.style.backgroundImage = `url("${encodeURI(imageUrl)}")`;
            } else {
                heroEl.style.backgroundImage = 'linear-gradient(120deg, #dbeafe, #bfdbfe)';
            }

            loadingEl.classList.add('d-none');
            errorEl.classList.add('d-none');
            bodyEl.classList.remove('d-none');
        };

        const showError = (message) => {
            loadingEl.classList.add('d-none');
            bodyEl.classList.add('d-none');
            errorEl.textContent = message || 'Không thể tải chi tiết sự kiện.';
            errorEl.classList.remove('d-none');
        };

        const loadEventDetail = async () => {
            if (!Number.isInteger(eventId) || eventId <= 0) {
                showError('ID sự kiện không hợp lệ.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/events/${eventId}`, {
                    method: 'GET',
                    headers: { Accept: 'application/json' }
                });
                const payload = await response.json().catch(() => ({}));
                if (!response.ok) {
                    throw new Error(payload.error || 'Không tìm thấy sự kiện.');
                }
                renderDetail(payload);
            } catch (error) {
                console.error('Cannot load event detail:', error);
                showError(error && error.message ? error.message : 'Không thể tải chi tiết sự kiện.');
            }
        };

        loadEventDetail();
    })();
</script>
</body>
</html>
