<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Diễn đàn Sinh viên & Tri thức Việt tại Pháp (SVP)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:ital,wght@1,700&family=Roboto+Condensed:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="svp.css">
    <link rel="stylesheet" href="dropdown-hover.css">
    <style>
        .sv-editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: .45rem;
            margin-bottom: .6rem;
        }
        .sv-editor-toolbar .btn {
            border-radius: 8px;
            min-width: 38px;
        }
        .sv-upload-box {
            margin-top: .6rem;
            border: 1px dashed #cbd5e1;
            border-radius: 10px;
            padding: .85rem .95rem;
            background: #f8fafc;
            color: #475569;
            font-size: .9rem;
        }
        .sv-preview-cover {
            width: 100%;
            aspect-ratio: 16 / 8;
            border-radius: 10px;
            display: none;
            background: linear-gradient(120deg, #dbeafe, #bfdbfe);
            border: 1px solid #dbe7ff;
            margin-bottom: .8rem;
            background-size: cover;
            background-position: center;
        }
        .sv-category-list {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
        }
        .sv-editor {
            min-height: 320px;
            border: 1px solid var(--sv-border);
            border-radius: 10px;
            padding: .85rem 1rem;
            background: #fff;
            line-height: 1.65;
            outline: none;
        }
        .sv-editor:focus {
            border-color: #93c5fd;
            box-shadow: 0 0 0 .2rem rgba(59,130,246,.15);
        }
        .sv-editor:empty::before {
            content: attr(data-placeholder);
            color: #94a3b8;
        }
        .sv-editor img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem auto;
            border-radius: 8px;
        }
        .sv-embed-video {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            margin: 1rem 0;
            border-radius: 8px;
            overflow: hidden;
            background: #0f172a;
        }
        .sv-embed-video iframe {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
    </style>
</head>
<body>

<!-- Top brand + auth -->
<div class="sv-topbar pt-2 pb-1">
    <div class="container d-flex align-items-center justify-content-between">
        <div class="sv-brand">
            <img class="sv-brand__logo-img" src="assets/icons/logo_svp.png" alt="SVP" width="102" height="112" />
            <div class="sv-brand__title">
                <h1>DIỄN ĐÀN SINH VIÊN & TRI THỨC VIỆT TẠI PHÁP <span class="sv-brand__accent">(SVP)</span></h1>
                <div class="sv-brand__divider"></div>
                <small class="sv-brand__tagline">Kết Nối – Chia Sẻ – Thành Công</small>
            </div>
        </div>

        <div class="sv-auth d-none d-md-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary">Đăng Ký</button>
            <button class="btn btn-primary">Đăng Nhập</button>
        </div>
    </div>
</div>

<!-- Main nav -->
<div class="sv-nav">
    <div class="container d-flex align-items-center justify-content-between">
        <ul class="nav">
            <li class="nav-item"><a class="nav-link" href="index.html">Trang Chủ</a></li>
            <li class="nav-item"><a class="nav-link" href="forum.html">Diễn Đàn</a></li>
            <li class="nav-item"><a class="nav-link active" href="categories.html">Khám Phá Chủ Đề</a></li>
            <li class="nav-item"><a class="nav-link" href="events.html">Sự Kiện & Lễ Hội</a></li>
            <li class="nav-item"><a class="nav-link" href="ban-do-paris.html">Bản Đồ Paris</a></li>
            <li class="nav-item"><a class="nav-link" href="about.html">Giới Thiệu</a></li>
        </ul>

        <div class="sv-search position-relative my-2 my-md-0" style="width:min(320px, 60vw);">
            <i class="fa fa-magnifying-glass"></i>
            <input class="form-control" type="search" placeholder="Tìm kiếm..." />
        </div>
    </div>
</div>
<main class="container my-3 my-md-4">
    <div class="sv-breadcrumb">
        <a href="index.html">Trang chủ</a> / <span>Đăng bài viết</span>
    </div>

    <section class="sv-page-hero mb-3">
        <div class="sv-page-hero__eyebrow">Trình soạn thảo</div>
        <h2 class="sv-page-hero__title">Đăng bài viết dài có ảnh</h2>
        <p class="sv-page-hero__subtitle">Soạn thảo dành cho bài viết đăng trên trang chủ. Bạn có thể thêm ảnh đại diện và biên tập nội dung dài nhiều phần với trình soạn thảo trực quan.</p>
    </section>

    <div class="row g-3">
        <div class="col-lg-8">
            <section class="sv-card">
                <div class="sv-card__hd d-flex justify-content-between align-items-center gap-2">
                    <span><i class="fa-solid fa-pen-nib me-2 text-primary"></i>Nội Dung Bài Viết</span>
                </div>
                <form id="article-form" class="sv-form p-3">
                    <div id="article-email-wrap" class="mb-3 d-none">
                        <label for="article-email" class="form-label">Email xác thực</label>
                        <input id="article-email" class="form-control" type="email" placeholder="Nhập email để xác thực đăng bài">
                        <div class="sv-meta mt-1" style="color:#b91c1c;">Bạn cần nhập email và xác thực magic link trước khi bài được xuất bản.</div>
                    </div>

                    <div class="mb-3">
                        <label for="article-title" class="form-label">Tiêu đề bài viết</label>
                        <input id="article-title" class="form-control" type="text" placeholder="Ví dụ: Lộ trình săn học bổng Master tại Pháp" required>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-7">
                            <label for="article-category" class="form-label">Chuyên mục</label>
                            <select id="article-category" class="form-select">
                                <option value="1">1 - Học tập và nghiên cứu tại Pháp</option>
                                <option value="2">2 - Kinh nghiệm xin học bổng và du học</option>
                                <option value="3">3 - Cuộc sống tại Pháp</option>
                                <option value="4">4 - Cơ hội việc làm và thực tập</option>
                                <option value="5">5 - Các vấn đề pháp lý, quốc tịch và thuế khóa</option>
                                <option value="6">6 - Văn hóa và ngôn ngữ Pháp</option>
                                <option value="7">7 - Sự kiện và giao lưu</option>
                                <option value="8">8 - Nhà cửa</option>
                                <option value="9">9 - Mua bán, rao vặt</option>
                                <option value="10">10 - Đầu tư tại Pháp</option>
                                <option value="11">11 - Chia sẻ trải nghiệm, câu chuyện cá nhân</option>
                                <option value="12">12 - Công nghệ, kỹ năng và tri thức mở</option>
                                <option value="13">13 - Giải trí, du lịch</option>
                                <option value="14">14 - Góc văn học và nghệ thuật</option>
                                <option value="15">15 - Nơi gặp gỡ, hẹn hò nghiêm túc</option>
                                <option value="16">16 - Chém gió, tán gẫu</option>
                                <option value="17">17 - Góp ý xây dựng SVP</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="article-cover-url" class="form-label">URL ảnh đại diện</label>
                        <input id="article-cover-url" class="form-control" type="url" placeholder="https://...">
                    </div>

                    <div class="mb-3">
                        <div id="article-cover-preview" class="sv-preview-cover" aria-label="Xem trước ảnh đại diện"></div>
                        <label for="article-cover-file" class="form-label">Hoặc tải ảnh từ máy</label>
                        <input id="article-cover-file" class="form-control" type="file" accept="image/*">

                        <div id="article-cover-upload-status" class="sv-meta mt-2"></div>
                    </div>

                    <div class="mb-3">
                        <label for="article-content-editor" class="form-label">Nội dung bài viết</label>
                        <div class="sv-editor-toolbar">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-command="bold" title="In đậm"><i class="fa-solid fa-bold"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-command="italic" title="In nghiêng"><i class="fa-solid fa-italic"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-command="insertUnorderedList" title="Danh sách"><i class="fa-solid fa-list-ul"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-command="formatBlock" data-value="blockquote" title="Trích dẫn"><i class="fa-solid fa-quote-left"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-action="insert-image-url" title="Chèn ảnh từ URL"><i class="fa-regular fa-image"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-action="insert-youtube" title="Chèn video YouTube"><i class="fa-brands fa-youtube"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-action="create-link" title="Chèn liên kết"><i class="fa-solid fa-link"></i></button>
                        </div>
                        <div id="article-content-editor" class="sv-editor" contenteditable="true" data-placeholder="Viết nội dung dài kiểu tạp chí ở đây..."></div>
                        <input id="article-content" type="hidden" name="article-content">
                    </div>



                    <div class="d-flex flex-wrap justify-content-between gap-2">

                        <button type="submit" class="btn btn-primary"><i class="fa-solid fa-paper-plane me-2"></i>Đăng bài viết</button>
                    </div>
                    <div id="article-submit-feedback" class="sv-meta mt-3" aria-live="polite"></div>
                </form>
            </section>
        </div>

    </div>
</main>

<footer class="container py-4">
    <div class="row">
        <div class="col-md">
            <div class="sv-brand d-flex align-items-center mb-2">
                <div class="sv-brand__logo" style="width:36px; height:36px; font-size:14px;">SVP</div>
                <strong class="ms-2">SVP - Kết Nối • Chia Sẻ • Thành Công</strong>
            </div>
            <div>© 2026 SVP. Mọi quyền được bảo lưu.</div>
        </div>
        <div class="col-md text-md-end mt-2 mt-md-0">
            <a class="me-3" href="/terms.html">Điều khoản</a>
            <a class="me-3" href="/security.html">Bảo mật</a>
            <a href="/contact.html">Liên hệ</a>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function () {
        const API_BASE_URL = window.SVP_API_BASE_URL || 'http://localhost:8080';
        const form = document.getElementById('article-form');
        const titleInput = document.getElementById('article-title');
        const contentEditor = document.getElementById('article-content-editor');
        const contentHiddenInput = document.getElementById('article-content');
        const coverUrlInput = document.getElementById('article-cover-url');
        const coverFileInput = document.getElementById('article-cover-file');
        const coverPreview = document.getElementById('article-cover-preview');
        const coverUploadStatus = document.getElementById('article-cover-upload-status');
        const categoryInput = document.getElementById('article-category');
        const emailWrap = document.getElementById('article-email-wrap');
        const emailInput = document.getElementById('article-email');
        const feedback = document.getElementById('article-submit-feedback');
        const toolbarButtons = Array.from(document.querySelectorAll('.sv-editor-toolbar button'));
        let savedRange = null;
        let isUploadingCover = false;
        let isPreparingCoverFromUrl = false;
        let coverUrlResolveTimer = null;
        let coverUrlResolveSeq = 0;
        let lastResolvedCoverUrl = '';
        let pendingCoverFile = null;
        let pendingCoverPreviewUrl = '';
        const MAX_IMAGE_UPLOAD_BYTES = 100 * 1024;

        if (!form || !titleInput || !contentEditor || !contentHiddenInput || !coverUrlInput || !coverFileInput || !coverPreview || !coverUploadStatus || !categoryInput || !feedback || !emailWrap || !emailInput) {
            return;
        }

        const sanitizeUrl = (url) => {
            const raw = String(url || '').trim();
            if (!raw) return '';

            const cssUrlMatch = raw.match(/url\(\s*(['"]?)(https?:\/\/[^'"\\)\s]+)\1\s*\)/i);
            const candidate = cssUrlMatch && cssUrlMatch[2]
                ? cssUrlMatch[2].trim()
                : raw;
            if (!/^https?:\/\//i.test(candidate)) {
                return '';
            }

            try {
                const parsed = new URL(candidate);
                if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') {
                    return '';
                }
                return parsed.toString();
            } catch (_) {
                return '';
            }
        };

        const hideCoverPreview = () => {
            coverPreview.style.display = 'none';
            coverPreview.style.backgroundImage = 'none';
        };

        const clearPendingCoverPreview = () => {
            if (pendingCoverPreviewUrl) {
                URL.revokeObjectURL(pendingCoverPreviewUrl);
                pendingCoverPreviewUrl = '';
            }
        };

        const clearPendingCoverFile = () => {
            pendingCoverFile = null;
            clearPendingCoverPreview();
            coverFileInput.value = '';
            lastResolvedCoverUrl = '';
        };

        const cancelCoverUrlResolve = () => {
            if (coverUrlResolveTimer) {
                clearTimeout(coverUrlResolveTimer);
                coverUrlResolveTimer = null;
            }
            coverUrlResolveSeq += 1;
            isPreparingCoverFromUrl = false;
        };

        const refreshCoverPreview = () => {
            if (pendingCoverPreviewUrl) {
                coverPreview.style.display = 'block';
                coverPreview.style.backgroundImage = `url('${pendingCoverPreviewUrl}')`;
                return;
            }
            hideCoverPreview();
        };

        const inferFileNameFromUrl = (rawUrl, mimeType) => {
            let baseName = 'cover-image';
            try {
                const parsed = new URL(rawUrl);
                const path = parsed.pathname || '';
                const lastSegment = decodeURIComponent(path.split('/').filter(Boolean).pop() || '');
                if (lastSegment) {
                    baseName = lastSegment.replace(/\.[^/.]+$/, '') || baseName;
                }
            } catch (_) {
            }
            const extension = imageExtensionForMime(mimeType);
            return `${baseName}.${extension}`;
        };

        const loadCoverFromUrlToPendingFile = async (url, statusPrefix) => {
            const safeUrl = sanitizeUrl(url);
            if (!safeUrl) {
                return false;
            }

            const currentSeq = ++coverUrlResolveSeq;
            isPreparingCoverFromUrl = true;
            setCoverUploadStatus(statusPrefix || 'Đang tải ảnh từ URL...', 'info');
            try {
                const response = await fetch(safeUrl, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-store'
                });
                if (!response.ok) {
                    throw new Error(`Không thể tải ảnh từ URL (${response.status}).`);
                }
                const blob = await response.blob();
                const mimeType = (blob.type || '').toLowerCase();
                if (!mimeType.startsWith('image/')) {
                    throw new Error('URL không trả về dữ liệu ảnh hợp lệ.');
                }
                if (currentSeq !== coverUrlResolveSeq) {
                    return false;
                }

                clearPendingCoverPreview();
                pendingCoverPreviewUrl = URL.createObjectURL(blob);
                pendingCoverFile = new File(
                    [blob],
                    inferFileNameFromUrl(safeUrl, mimeType),
                    { type: mimeType || 'application/octet-stream' }
                );
                lastResolvedCoverUrl = safeUrl;
                refreshCoverPreview();
                setCoverUploadStatus('Ảnh URL đã được tải cục bộ. Ảnh sẽ được upload khi bấm "Đăng bài viết".', 'info');
                return true;
            } catch (error) {
                if (currentSeq !== coverUrlResolveSeq) {
                    return false;
                }
                throw error;
            } finally {
                if (currentSeq === coverUrlResolveSeq) {
                    isPreparingCoverFromUrl = false;
                }
            }
        };

        const saveSelection = () => {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) return;
            const range = selection.getRangeAt(0);
            if (!contentEditor.contains(range.commonAncestorContainer)) return;
            savedRange = range.cloneRange();
        };

        const restoreSelection = () => {
            const selection = window.getSelection();
            if (!selection) return;
            if (savedRange) {
                selection.removeAllRanges();
                selection.addRange(savedRange);
            } else {
                const range = document.createRange();
                range.selectNodeContents(contentEditor);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        };

        const insertImageAtCursor = (url) => {
            const safeUrl = sanitizeUrl(url);
            if (!safeUrl) return;
            contentEditor.focus();
            restoreSelection();
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) return;
            const range = selection.getRangeAt(0);
            const image = document.createElement('img');
            image.src = safeUrl;
            image.alt = 'Article illustration';
            range.insertNode(image);
            range.setStartAfter(image);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            saveSelection();
        };

        const parseYoutubeTimeToSeconds = (value) => {
            const raw = (value || '').trim().toLowerCase();
            if (!raw) return '';
            if (/^\d+$/.test(raw)) return raw;
            const match = raw.match(/^(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?$/);
            if (!match) return '';
            const hours = Number(match[1] || 0);
            const minutes = Number(match[2] || 0);
            const seconds = Number(match[3] || 0);
            const total = (hours * 3600) + (minutes * 60) + seconds;
            return total > 0 ? String(total) : '';
        };

        const getYoutubeEmbedUrl = (url) => {
            const safeUrl = sanitizeUrl(url);
            if (!safeUrl) return '';
            let videoId = '';
            const embedParams = new URLSearchParams();

            try {
                const parsed = new URL(safeUrl);
                const host = parsed.hostname.replace(/^www\./i, '').toLowerCase();
                if (host === 'youtube.com' || host === 'm.youtube.com') {
                    if (parsed.pathname === '/watch') {
                        videoId = parsed.searchParams.get('v') || '';
                    } else if (parsed.pathname.startsWith('/shorts/')) {
                        videoId = parsed.pathname.split('/')[2] || '';
                    } else if (parsed.pathname.startsWith('/embed/')) {
                        videoId = parsed.pathname.split('/')[2] || '';
                    }
                } else if (host === 'youtu.be') {
                    videoId = parsed.pathname.replace('/', '').trim();
                }

                const si = parsed.searchParams.get('si');
                if (si) embedParams.set('si', si);

                const start = parsed.searchParams.get('start') || parsed.searchParams.get('t');
                const startSeconds = parseYoutubeTimeToSeconds(start || '');
                if (startSeconds) embedParams.set('start', startSeconds);
            } catch (error) {
                return '';
            }

            videoId = videoId.replace(/[^a-zA-Z0-9_-]/g, '');
            if (!videoId) return '';
            const query = embedParams.toString();
            return `https://www.youtube.com/embed/${videoId}${query ? `?${query}` : ''}`;
        };

        const insertYoutubeAtCursor = (url) => {
            const embedUrl = getYoutubeEmbedUrl(url);
            if (!embedUrl) return false;
            contentEditor.focus();
            restoreSelection();
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) return false;
            const range = selection.getRangeAt(0);
            const wrapper = document.createElement('div');
            wrapper.className = 'sv-embed-video';
            const iframe = document.createElement('iframe');
            iframe.src = embedUrl;
            iframe.title = 'YouTube video player';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
            iframe.allowFullscreen = true;
            iframe.referrerPolicy = 'strict-origin-when-cross-origin';
            wrapper.appendChild(iframe);
            range.insertNode(wrapper);
            range.setStartAfter(wrapper);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            saveSelection();
            return true;
        };

        const updateDraft = () => {
            contentHiddenInput.value = contentEditor.innerHTML;
        };

        const normalizeEmail = (value) => (value || '').trim().toLowerCase();
        const isValidEmail = (value) => /^[^\s@]+@[^\s@]+$/.test(value);

        const pickEmailFromStorage = () => {
            const fromDirect = normalizeEmail(
                localStorage.getItem('userEmail')
                || localStorage.getItem('email')
                || localStorage.getItem('svp.email')
                || ''
            );
            if (isValidEmail(fromDirect)) {
                return fromDirect;
            }
            const accessToken = localStorage.getItem('accessToken') || '';
            const parts = accessToken.split('.');
            if (parts.length !== 3) {
                return '';
            }
            try {
                let payloadBase64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                const pad = payloadBase64.length % 4;
                if (pad) {
                    payloadBase64 += '='.repeat(4 - pad);
                }
                const payload = JSON.parse(atob(payloadBase64));
                const fromToken = normalizeEmail(payload?.email || payload?.sub || '');
                return isValidEmail(fromToken) ? fromToken : '';
            } catch (_) {
                return '';
            }
        };

        const getSessionEmail = async () => {
            if (window.SVPAuth && typeof window.SVPAuth.getValidAccessToken === 'function') {
                const validToken = await window.SVPAuth.getValidAccessToken();
                if (!validToken) {
                    return '';
                }
            }
            const email = pickEmailFromStorage();
            return isValidEmail(email) ? email : '';
        };

        const composeContentHtml = () => {
            const editorHtml = contentEditor.innerHTML.trim();
            const coverUrl = sanitizeUrl(coverUrlInput.value);
            const coverHtml = coverUrl ? `<p><img src="${coverUrl}" alt="cover image"></p>` : '';
            if (!editorHtml) {
                return coverHtml;
            }
            if (!coverHtml) {
                return editorHtml;
            }
            const containsCover = editorHtml.includes(`src="${coverUrl}"`) || editorHtml.includes(`src='${coverUrl}'`);
            return containsCover ? editorHtml : `${coverHtml}\n${editorHtml}`;
        };

        const setFeedback = (text, type) => {
            feedback.textContent = text;
            if (type === 'error') {
                feedback.style.color = '#b91c1c';
                return;
            }
            if (type === 'success') {
                feedback.style.color = '#15803d';
                return;
            }
            feedback.style.color = '#475569';
        };

        const setCoverUploadStatus = (text, type) => {
            coverUploadStatus.textContent = text || '';
            if (type === 'error') {
                coverUploadStatus.style.color = '#b91c1c';
                return;
            }
            if (type === 'success') {
                coverUploadStatus.style.color = '#15803d';
                return;
            }
            coverUploadStatus.style.color = '#475569';
        };

        const formatSize = (bytes) => `${(bytes / 1024).toFixed(1)}KB`;

        const loadImageFromFile = (file) => new Promise((resolve, reject) => {
            const objectUrl = URL.createObjectURL(file);
            const image = new Image();
            image.onload = () => {
                URL.revokeObjectURL(objectUrl);
                resolve(image);
            };
            image.onerror = () => {
                URL.revokeObjectURL(objectUrl);
                reject(new Error('Không đọc được ảnh để nén.'));
            };
            image.src = objectUrl;
        });

        const canvasToBlob = (canvas, mimeType, quality) => new Promise((resolve) => {
            canvas.toBlob((blob) => resolve(blob), mimeType, quality);
        });

        const replaceFileExtension = (filename, newExtension) => {
            const raw = (filename || 'cover-image').trim();
            const base = raw.replace(/\.[^/.]+$/, '');
            return `${base}.${newExtension}`;
        };

        const imageExtensionForMime = (mimeType) => {
            const normalized = (mimeType || '').toLowerCase();
            if (normalized === 'image/webp') return 'webp';
            if (normalized === 'image/png') return 'png';
            if (normalized === 'image/gif') return 'gif';
            if (normalized === 'image/avif') return 'avif';
            return 'jpg';
        };

        const compressImageBelowLimit = async (file, maxBytes) => {
            if (!(file instanceof File) || file.size <= maxBytes) {
                return file;
            }

            const image = await loadImageFromFile(file);
            const sourceWidth = image.naturalWidth || image.width;
            const sourceHeight = image.naturalHeight || image.height;
            if (!sourceWidth || !sourceHeight) {
                throw new Error('Không xác định được kích thước ảnh.');
            }

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            if (!context) {
                throw new Error('Trình duyệt không hỗ trợ nén ảnh.');
            }

            const scaleCandidates = [1, 0.92, 0.84, 0.76, 0.68, 0.6, 0.52, 0.44, 0.36, 0.3, 0.25];
            const qualityCandidates = [0.9, 0.82, 0.74, 0.66, 0.58, 0.5, 0.42];
            const mimeCandidates = ['image/webp', 'image/jpeg'];
            if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
                mimeCandidates.unshift('image/jpeg');
            } else if (file.type === 'image/webp') {
                mimeCandidates.unshift('image/webp');
            }

            let bestBlob = null;
            let bestMime = 'image/jpeg';

            for (const scale of scaleCandidates) {
                const targetWidth = Math.max(1, Math.round(sourceWidth * scale));
                const targetHeight = Math.max(1, Math.round(sourceHeight * scale));
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                context.clearRect(0, 0, targetWidth, targetHeight);
                context.drawImage(image, 0, 0, targetWidth, targetHeight);

                for (const mimeType of mimeCandidates) {
                    for (const quality of qualityCandidates) {
                        const blob = await canvasToBlob(canvas, mimeType, quality);
                        if (!blob) {
                            continue;
                        }

                        if (!bestBlob || blob.size < bestBlob.size) {
                            bestBlob = blob;
                            bestMime = mimeType;
                        }
                        if (blob.size <= maxBytes) {
                            const extension = imageExtensionForMime(mimeType);
                            const outputName = replaceFileExtension(file.name, extension);
                            return new File([blob], outputName, { type: mimeType });
                        }
                    }
                }
            }

            if (!bestBlob) {
                throw new Error('Không thể nén ảnh.');
            }

            throw new Error(
                `Không thể nén ảnh xuống dưới ${formatSize(maxBytes)}. Kích thước nhỏ nhất đạt được là ${formatSize(bestBlob.size)}.`
            );
        };

        const uploadCoverToCloudflare = async (file) => {
            if (!file) {
                return;
            }
            if (!file.type || !file.type.toLowerCase().startsWith('image/')) {
                throw new Error('Chỉ hỗ trợ file ảnh.');
            }
            setCoverUploadStatus(`Đang tải ảnh...`, 'info');
            const compressedFile = await compressImageBelowLimit(file, MAX_IMAGE_UPLOAD_BYTES);
            if (compressedFile.size !== file.size) {
                setCoverUploadStatus(
                    `Đã nén ảnh từ ${formatSize(file.size)} xuống ${formatSize(compressedFile.size)}. Đang upload...`,
                    'info'
                );
            } else {
                setCoverUploadStatus(`Ảnh đã ở mức ${formatSize(compressedFile.size)}. Đang upload...`, 'info');
            }

            const accessToken = window.SVPAuth && typeof window.SVPAuth.getValidAccessToken === 'function'
                ? await window.SVPAuth.getValidAccessToken()
                : (localStorage.getItem('accessToken') || '');

            const presignResponse = await fetch(`${API_BASE_URL}/api/upload/post-image`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    ...(accessToken ? { Authorization: `Bearer ${accessToken}` } : {})
                },
                body: JSON.stringify({
                    filename: compressedFile.name || 'cover-image',
                    contentType: compressedFile.type || 'application/octet-stream'
                })
            });
            const presignPayload = await presignResponse.json().catch(() => ({}));
            if (!presignResponse.ok) {
                throw new Error(presignPayload.error || 'Không lấy được presigned URL.');
            }

            const uploadMethod = (presignPayload.method || 'PUT').toUpperCase();
            if (uploadMethod !== 'PUT') {
                throw new Error('Upload method không hợp lệ.');
            }
            const uploadUrl = (presignPayload.uploadUrl || '').trim();
            const publicUrl = (presignPayload.publicUrl || '').trim();
            if (!uploadUrl || !publicUrl) {
                throw new Error('Thiếu uploadUrl/publicUrl từ API.');
            }
            let uploadResponse;
            try {
                uploadResponse = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': compressedFile.type
                    },
                    body: compressedFile
                });
            } catch (firstError) {
                // Retry without Content-Type to reduce CORS preflight header requirements.
                try {
                    const binaryBody = await compressedFile.arrayBuffer();
                    uploadResponse = await fetch(uploadUrl, {
                        method: 'PUT',
                        body: binaryBody
                    });
                } catch (secondError) {
                    throw new Error('Upload bị chặn do CORS trên Cloudflare R2. Hãy bật CORS cho origin http://localhost:63342, method PUT, allowed headers *.');
                }
            }
            if (!uploadResponse.ok) {
                throw new Error(`Upload lên R2 thất bại (${uploadResponse.status}).`);
            }

            coverUrlInput.value = publicUrl;
            updateDraft();
            clearPendingCoverFile();
            refreshCoverPreview();

            setCoverUploadStatus('Upload ảnh thành công.', 'success');
        };

        const toFriendlyUploadError = (error) => {
            const message = error && error.message ? String(error.message) : '';
            if (!message) {
                return 'Upload ảnh thất bại.';
            }
            if (message.toLowerCase().includes('failed to fetch')) {
                return 'Upload bị chặn do CORS trên Cloudflare R2. Hãy bật CORS cho origin http://localhost:63342, method PUT, allowed headers *.';
            }
            return message;
        };

        [titleInput, coverUrlInput, categoryInput].forEach((element) => {
            element.addEventListener('input', updateDraft);
            element.addEventListener('change', updateDraft);
        });
        ['keyup', 'mouseup', 'blur'].forEach((eventName) => {
            contentEditor.addEventListener(eventName, saveSelection);
        });
        contentEditor.addEventListener('input', updateDraft);
        coverUrlInput.addEventListener('input', () => {
            const safeUrl = sanitizeUrl(coverUrlInput.value);
            cancelCoverUrlResolve();
            if (!safeUrl) {
                lastResolvedCoverUrl = '';
                refreshCoverPreview();
                setCoverUploadStatus('', 'info');
                return;
            }
            if (pendingCoverFile && safeUrl === lastResolvedCoverUrl) {
                refreshCoverPreview();
                setCoverUploadStatus('Ảnh URL đã được tải cục bộ. Ảnh sẽ được upload khi bấm "Đăng bài viết".', 'info');
                return;
            }
            clearPendingCoverFile();
            refreshCoverPreview();
            coverUrlResolveTimer = window.setTimeout(async () => {
                try {
                    await loadCoverFromUrlToPendingFile(safeUrl, 'Đang tải ảnh từ URL về cục bộ...');
                } catch (_) {
                    setCoverUploadStatus('Không thể tải ảnh từ URL (có thể do CORS hoặc URL không hợp lệ). Vui lòng tải ảnh từ máy.', 'error');
                }
            }, 250);
        });
        coverFileInput.addEventListener('change', (event) => {
            const file = event.target && event.target.files ? event.target.files[0] : null;
            if (!file) {
                cancelCoverUrlResolve();
                clearPendingCoverFile();
                lastResolvedCoverUrl = '';
                refreshCoverPreview();
                setCoverUploadStatus('', 'info');
                return;
            }
            if (!file.type || !file.type.toLowerCase().startsWith('image/')) {
                cancelCoverUrlResolve();
                clearPendingCoverFile();
                lastResolvedCoverUrl = '';
                refreshCoverPreview();
                setCoverUploadStatus('Chỉ hỗ trợ file ảnh.', 'error');
                return;
            }
            cancelCoverUrlResolve();
            clearPendingCoverPreview();
            pendingCoverPreviewUrl = URL.createObjectURL(file);
            pendingCoverFile = file;
            coverUrlInput.value = '';
            lastResolvedCoverUrl = '';
            refreshCoverPreview();
            updateDraft();
            setCoverUploadStatus('Ảnh đã được chọn cục bộ. Ảnh sẽ được upload khi bấm "Đăng bài viết".', 'info');
        });

        toolbarButtons.forEach((button) => {
            button.addEventListener('click', () => {
                const action = button.getAttribute('data-action');
                const command = button.getAttribute('data-command');
                const value = button.getAttribute('data-value') || null;

                if (action === 'insert-image-url') {
                    const imageUrl = prompt('Nhập URL ảnh (http/https):');
                    if (imageUrl) insertImageAtCursor(imageUrl);
                    updateDraft();
                    return;
                }

                if (action === 'insert-youtube') {
                    const videoUrl = prompt('Nhập URL YouTube (watch, shorts hoặc youtu.be):');
                    if (videoUrl) {
                        const inserted = insertYoutubeAtCursor(videoUrl);
                        if (!inserted) {
                            alert('URL YouTube không hợp lệ.');
                        }
                    }
                    updateDraft();
                    return;
                }

                if (action === 'create-link') {
                    const linkUrl = sanitizeUrl(prompt('Nhập URL liên kết (http/https):'));
                    if (!linkUrl) return;
                    contentEditor.focus();
                    restoreSelection();
                    document.execCommand('createLink', false, linkUrl);
                    saveSelection();
                    updateDraft();
                    return;
                }

                if (!command) return;
                contentEditor.focus();
                restoreSelection();
                if (command === 'formatBlock' && value) {
                    document.execCommand(command, false, value);
                } else {
                    document.execCommand(command, false, null);
                }
                saveSelection();
                updateDraft();
            });
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            updateDraft();

            if (isUploadingCover) {
                setFeedback('Ảnh đại diện đang tải lên máy chủ. Vui lòng chờ xong rồi đăng bài.', 'error');
                return;
            }
            if (isPreparingCoverFromUrl) {
                setFeedback('Ảnh từ URL đang được tải cục bộ. Vui lòng chờ xong rồi đăng bài.', 'error');
                return;
            }

            const sessionEmail = await getSessionEmail();
            const manualEmail = normalizeEmail(emailInput.value);
            const email = sessionEmail || manualEmail;
            if (!email) {
                emailWrap.classList.remove('d-none');
                setFeedback('Bạn chưa đăng nhập. Vui lòng nhập email để nhận magic link xác thực đăng bài.', 'error');
                emailInput.focus();
                return;
            }
            if (!sessionEmail && !isValidEmail(email)) {
                emailWrap.classList.remove('d-none');
                setFeedback('Email chưa hợp lệ.', 'error');
                emailInput.focus();
                return;
            }

            if (sessionEmail) {
                emailInput.value = sessionEmail;
                emailWrap.classList.add('d-none');
            }

            const title = titleInput.value.trim();
            const categoryId = Number(categoryInput.value);
            if (!title || title.length < 5) {
                setFeedback('Tiêu đề cần tối thiểu 5 ký tự.', 'error');
                titleInput.focus();
                return;
            }
            if (!Number.isInteger(categoryId) || categoryId <= 0) {
                setFeedback('Chuyên mục không hợp lệ.', 'error');
                return;
            }

            const submitBtn = form.querySelector('button[type="submit"]');
            const oldLabel = submitBtn ? submitBtn.innerHTML : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Đang gửi...';
            }
            setFeedback('Đang gửi bài viết, vui lòng đợi...', 'info');

            try {
                const accessToken = window.SVPAuth && typeof window.SVPAuth.getValidAccessToken === 'function'
                    ? await window.SVPAuth.getValidAccessToken()
                    : (localStorage.getItem('accessToken') || '');

                const inputCoverUrl = sanitizeUrl(coverUrlInput.value);
                if (inputCoverUrl && !pendingCoverFile) {
                    try {
                        await loadCoverFromUrlToPendingFile(inputCoverUrl, 'Đang tải ảnh URL trước khi upload...');
                    } catch (_) {
                        setCoverUploadStatus('Không thể tải ảnh từ URL (có thể do CORS hoặc URL không hợp lệ). Vui lòng tải ảnh từ máy.', 'error');
                        setFeedback('Không thể chuẩn bị ảnh URL để upload.', 'error');
                        return;
                    }
                }

                if (pendingCoverFile) {
                    isUploadingCover = true;
                    coverFileInput.disabled = true;
                    setCoverUploadStatus('Đang upload ảnh lên Cloudflare R2...', 'info');
                    try {
                        await uploadCoverToCloudflare(pendingCoverFile);
                    } catch (uploadError) {
                        setCoverUploadStatus(toFriendlyUploadError(uploadError), 'error');
                        setFeedback('Không thể upload ảnh đại diện.', 'error');
                        return;
                    } finally {
                        isUploadingCover = false;
                        coverFileInput.disabled = false;
                    }
                }

                const contentHtml = composeContentHtml();
                if (!contentHtml || contentHtml.replace(/<[^>]+>/g, ' ').trim().length < 20) {
                    setFeedback('Nội dung bài viết cần chi tiết hơn (ít nhất 20 ký tự).', 'error');
                    contentEditor.focus();
                    return;
                }
                const response = await fetch(`${API_BASE_URL}/posts/articles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                        ...(accessToken ? { Authorization: `Bearer ${accessToken}` } : {})
                    },
                    body: JSON.stringify({
                        email,
                        categoryId,
                        title,
                        contentHtml
                    })
                });
                const payload = await response.json().catch(() => ({}));
                if (!response.ok) {
                    setFeedback(payload.error || 'Không thể gửi bài viết.', 'error');
                    return;
                }

                const postId = payload.postId || 'N/A';
                const status = String(payload.status || '').toUpperCase();
                const expiresAt = payload.verifyExpiresAt || '';
                const debugLink = payload.verifyLink ? `\nLink xác thực (dev): ${payload.verifyLink}` : '';
                if (status === 'PUBLISHED') {
                    setFeedback(
                        `Bài viết #${postId} đã được xuất bản ngay với trạng thái PUBLISHED.`,
                        'success'
                    );
                } else {
                    setFeedback(
                        `Bài viết #${postId} đã được tạo với trạng thái PENDING. Hãy kiểm tra email ${email} và bấm magic link để xuất bản.${expiresAt ? ` (Hết hạn: ${expiresAt})` : ''}${debugLink}`,
                        'success'
                    );
                }
                const authorName = (localStorage.getItem('userNickname') || email || '').trim();
                const localPost = {
                    postId,
                    categoryId,
                    title,
                    contentHtml,
                    createdAt: new Date().toISOString(),
                    status: status || 'PENDING',
                    author: {
                        displayName: authorName,
                        nickname: authorName
                    }
                };
                try {
                    localStorage.setItem('svp.latestSubmittedArticle', JSON.stringify(localPost));
                } catch (_) {
                }
                localStorage.setItem('userEmail', email);
                form.reset();
                contentEditor.innerHTML = '';
                contentHiddenInput.value = '';
                cancelCoverUrlResolve();
                clearPendingCoverFile();
                refreshCoverPreview();
                setCoverUploadStatus('', 'info');
                emailInput.value = email;
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 600);
            } catch (_) {
                setFeedback('Không thể kết nối API.', 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = oldLabel;
                }
            }
        });

        const initialEmail = pickEmailFromStorage();
        if (initialEmail) {
            emailInput.value = initialEmail;
            emailWrap.classList.add('d-none');
        }
        refreshCoverPreview();
        updateDraft();
    })();
</script>
<script src="auth-topbar.js"></script>
</body>
</html>
