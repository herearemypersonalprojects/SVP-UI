<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chi tiết chủ đề - SVP Forum</title>
    <link rel="icon" type="image/svg+xml" href="assets/icons/favicon.svg">
    <link rel="shortcut icon" href="assets/icons/favicon.svg">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:ital,wght@1,700&family=Roboto+Condensed:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="svp.css">
    <link rel="stylesheet" href="dropdown-hover.css">
    <style>
        .sv-thread-head {
            background: #fff;
            border: 1px solid var(--sv-border);
            border-radius: 12px;
            padding: 1rem 1.2rem;
        }
        .sv-thread-head__meta {
            display: flex;
            flex-wrap: wrap;
            gap: .55rem 1rem;
            color: #64748b;
            font-size: .86rem;
            margin-bottom: .45rem;
        }
        .sv-thread-head__title {
            margin: .2rem 0 .55rem;
            color: #1e3a8a;
            font-family: var(--sv-title-font);
            font-size: 1.75rem;
            font-weight: 800;
        }
        .sv-thread-post {
            display: grid;
            grid-template-columns: 180px minmax(0, 1fr);
            border-bottom: 1px solid #e2e8f0;
        }
        .sv-thread-post:last-child {
            border-bottom: 0;
        }
        .sv-thread-post__author {
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            padding: .9rem .8rem;
            text-align: center;
        }
        .sv-thread-post__avatar {
            width: 58px;
            height: 58px;
            border-radius: 50%;
            margin: 0 auto .45rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 800;
            background: linear-gradient(135deg, #1a73e8, #1558b0);
        }
        .sv-thread-post__name {
            font-weight: 800;
            color: #0f172a;
            line-height: 1.25;
        }
        .sv-thread-post__role {
            margin-top: .25rem;
            color: #64748b;
            font-size: .82rem;
        }
        .sv-thread-post__body {
            padding: .7rem .95rem .85rem;
        }
        .sv-thread-post__meta {
            display: flex;
            justify-content: space-between;
            gap: .5rem;
            color: #64748b;
            font-size: .82rem;
            border-bottom: 1px dashed #e2e8f0;
            padding-bottom: .42rem;
            margin-bottom: .5rem;
        }
        .sv-thread-post__content p {
            margin-bottom: .55rem;
            color: #1f2937;
            line-height: 1.6;
        }
        .sv-thread-post__actions {
            display: flex;
            gap: .75rem;
            flex-wrap: wrap;
            margin-top: .45rem;
        }
        .sv-thread-post__actions button {
            border: 0;
            padding: 0;
            background: transparent;
            color: var(--sv-primary);
            font-size: .83rem;
            font-weight: 700;
        }
        .sv-thread-post__actions button:hover {
            text-decoration: underline;
            color: var(--sv-primary-d);
        }
        .sv-thread-empty {
            padding: 1.15rem 1rem;
            color: #64748b;
            text-align: center;
        }
        .sv-char-count {
            text-align: right;
            color: #64748b;
            font-size: .84rem;
            margin-top: .35rem;
        }
        .sv-sticky {
            position: sticky;
            top: 1rem;
        }
        @media (max-width: 900px) {
            .sv-thread-post {
                grid-template-columns: 1fr;
            }
            .sv-thread-post__author {
                border-right: 0;
                border-bottom: 1px solid #e2e8f0;
                text-align: left;
                display: flex;
                align-items: center;
                gap: .75rem;
            }
            .sv-thread-post__avatar {
                margin: 0;
                width: 44px;
                height: 44px;
            }
        }
    </style>
</head>
<body>

<div class="sv-topbar pt-2 pb-1">
    <div class="container d-flex align-items-center justify-content-between">
        <div class="sv-brand">
            <img class="sv-brand__logo-img" src="assets/icons/logo_svp.png" alt="SVP" width="102" height="112" />
            <div class="sv-brand__title">
                <h1>DIỄN ĐÀN SINH VIÊN & TRI THỨC VIỆT TẠI PHÁP <span class="sv-brand__accent">(SVP)</span></h1>
                <div class="sv-brand__divider"></div>
                <small class="sv-brand__tagline">Kết Nối – Chia Sẻ – Thành Công</small>
            </div>
        </div>

        <div id="sv-auth-box" class="sv-auth d-none d-md-flex align-items-center gap-2">
            <a class="btn btn-outline-secondary" href="signup.html">Đăng Ký</a>
            <a class="btn btn-primary" href="login.html">Đăng Nhập</a>
        </div>
    </div>
</div>

<div class="sv-nav">
    <div class="container d-flex align-items-center justify-content-between">
        <ul class="nav">
            <li class="nav-item"><a class="nav-link" href="index.html">Trang Chủ</a></li>
            <li class="nav-item"><a class="nav-link active" href="forum.html">Diễn Đàn</a></li>
            <li class="nav-item"><a class="nav-link" href="categories.html">Khám Phá Chủ Đề</a></li>
            <li class="nav-item"><a class="nav-link" href="events.html">Sự Kiện & Lễ Hội</a></li>
            <li class="nav-item"><a class="nav-link" href="ban-do-paris.html">Bản Đồ Paris</a></li>
            <li class="nav-item"><a class="nav-link" href="about.html">Giới Thiệu</a></li>
        </ul>

        <div class="sv-search position-relative my-2 my-md-0" style="width:min(320px, 60vw);">
            <i class="fa fa-magnifying-glass"></i>
            <input class="form-control" type="search" placeholder="Tìm kiếm..." />
        </div>
    </div>
</div>

<main class="container my-3 my-md-4">
    <div class="sv-breadcrumb">
        <a href="index.html">Trang chủ</a> / <a href="forum.html">Diễn đàn</a> / <span id="thread-breadcrumb">Chi tiết chủ đề</span>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <section class="sv-thread-head mb-3">
                <div class="sv-thread-head__meta">
                    <span><i class="fa-solid fa-layer-group me-1 text-primary"></i><span id="thread-category">Đang tải...</span></span>
                    <span><i class="fa-regular fa-clock me-1 text-primary"></i><span id="thread-created">--</span></span>
                    <span><i class="fa-regular fa-eye me-1 text-primary"></i><span id="thread-views">--</span></span>
                    <span><i class="fa-regular fa-message me-1 text-primary"></i><span id="thread-replies">--</span></span>
                </div>
                <h2 id="thread-title" class="sv-thread-head__title">Đang tải chủ đề...</h2>
                <div id="thread-author" class="sv-meta mb-2"></div>
                <div id="thread-tags" class="d-flex flex-wrap gap-2"></div>
                <div class="mt-3 d-flex flex-wrap gap-2">
                    <a class="btn btn-sm btn-outline-secondary" href="forum.html"><i class="fa-solid fa-arrow-left me-1"></i>Quay lại forum</a>
                    <button id="btn-scroll-reply" class="btn btn-sm btn-primary" type="button"><i class="fa-solid fa-reply me-1"></i>Viết phản hồi</button>
                </div>
            </section>

            <section class="sv-card mb-3">
                <div class="sv-card__hd d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-comments me-2 text-primary"></i>Bài viết trong chủ đề</span>
                    <span id="posts-count" class="sv-meta">0 bài</span>
                </div>
                <div id="thread-status" class="sv-thread-empty">Đang tải dữ liệu...</div>
                <div id="thread-posts"></div>
            </section>

            <section id="reply-box" class="sv-card sv-form">
                <div class="sv-card__hd"><i class="fa-solid fa-pen me-2 text-primary"></i>Gửi phản hồi</div>
                <form id="reply-form" class="p-3" novalidate>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label for="reply-name" class="form-label">Tên hiển thị</label>
                            <input id="reply-name" class="form-control" type="text" placeholder="Ví dụ: Minh Đức" required>
                        </div>
                        <div class="col-md-6">
                            <label for="reply-email" class="form-label">Email</label>
                            <input id="reply-email" class="form-control" type="email" placeholder="ban@example.com" required>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="reply-message" class="form-label">Nội dung phản hồi</label>
                        <textarea id="reply-message" class="form-control" rows="5" maxlength="2000" placeholder="Chia sẻ câu trả lời, kinh nghiệm hoặc câu hỏi bổ sung..." required></textarea>
                        <div id="reply-char-count" class="sv-char-count">0/2000 ký tự</div>
                    </div>
                    <div class="mt-3 d-flex flex-wrap gap-2">
                        <button class="btn btn-primary" type="submit"><i class="fa-solid fa-paper-plane me-2"></i>Đăng phản hồi</button>
                        <button id="reply-clear" class="btn btn-outline-secondary" type="button">Xóa nội dung</button>
                    </div>
                    <div id="reply-feedback" class="sv-meta mt-3" aria-live="polite"></div>
                </form>
            </section>
        </div>

        <div class="col-lg-4">
            <div class="sv-sticky">
                <section class="sv-card mb-3">
                    <div class="sv-card__hd"><i class="fa-solid fa-chart-simple me-2 text-primary"></i>Thống kê chủ đề</div>
                    <ul id="thread-kpis" class="sv-list mb-0"></ul>
                </section>

                <section class="sv-card mb-3">
                    <div class="sv-card__hd"><i class="fa-solid fa-arrow-up-right-dots me-2 text-primary"></i>Chủ đề liên quan</div>
                    <ul id="related-list" class="sv-list mb-0"></ul>
                </section>

                <section class="sv-card">
                    <div class="sv-card__hd"><i class="fa-solid fa-shield-heart me-2 text-primary"></i>Quy tắc trao đổi</div>
                    <ul class="sv-list mb-0">
                        <li><div><strong>Tập trung vào giải pháp</strong><div class="sv-meta">Nêu rõ bối cảnh trước khi hỏi.</div></div></li>
                        <li><div><strong>Tôn trọng người khác</strong><div class="sv-meta">Không công kích cá nhân.</div></div></li>
                        <li><div><strong>Ưu tiên thông tin có nguồn</strong><div class="sv-meta">Khuyến khích gắn link chính thức.</div></div></li>
                    </ul>
                </section>
            </div>
        </div>
    </div>
</main>

<footer class="container py-4">
    <div class="row">
        <div class="col-md">
            <div class="sv-brand d-flex align-items-center mb-2">
                <div class="sv-brand__logo" style="width:36px; height:36px; font-size:14px;">SVP</div>
                <strong class="ms-2">SVP - Kết Nối • Chia Sẻ • Thành Công</strong>
            </div>
            <div>© 2026 SVP. Mọi quyền được bảo lưu.</div>
        </div>
        <div class="col-md text-md-end mt-2 mt-md-0">
            <a class="me-3" href="terms.html">Điều khoản</a>
            <a class="me-3" href="security.html">Bảo mật</a>
            <a href="contact.html">Liên hệ</a>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function () {
        const API_BASE_URL = window.SVP_API_BASE_URL || 'http://localhost:8080';
        const METRIC_KEY = 'svp.forum.thread.metrics.v1';
        const LOCAL_REPLY_PREFIX = 'svp.thread.localReplies.v1.';

        const CATEGORY_MAP = new Map([
            [1, 'Học tập và nghiên cứu tại Pháp'],
            [2, 'Kinh nghiệm xin học bổng và du học'],
            [3, 'Cuộc sống tại Pháp'],
            [4, 'Cơ hội việc làm và thực tập'],
            [5, 'Pháp lý, quốc tịch và thuế khóa'],
            [6, 'Văn hóa và ngôn ngữ Pháp'],
            [7, 'Sự kiện và giao lưu'],
            [8, 'Nhà cửa'],
            [9, 'Mua bán, rao vặt'],
            [10, 'Đầu tư tại Pháp'],
            [11, 'Trải nghiệm cá nhân'],
            [12, 'Công nghệ và kỹ năng'],
            [13, 'Giải trí, du lịch'],
            [14, 'Văn học và nghệ thuật'],
            [15, 'Gặp gỡ, hẹn hò'],
            [16, 'Chém gió, tán gẫu'],
            [17, 'Góp ý xây dựng SVP']
        ]);

        const FALLBACK_TOPICS = {
            1: {
                title: 'Kinh nghiệm gia hạn titre de sejour tại Paris',
                categoryId: 5,
                authorName: 'Ngọc Hà',
                createdAt: '2026-02-10T09:30:00Z',
                contentLines: [
                    'Mình tổng hợp lại quy trình gia hạn thẻ cư trú cho sinh viên tại Paris, kèm mốc thời gian chuẩn bị hồ sơ.',
                    'Bạn nên đặt lịch hẹn sớm tối thiểu 6-8 tuần trước ngày hết hạn để tránh thiếu giấy hẹn.',
                    'Nên scan hồ sơ theo tên file rõ ràng và giữ bản in đầy đủ để bổ sung nhanh khi được yêu cầu.'
                ],
                comments: [
                    { id: 1, authorName: 'Linh Chi', createdAt: '2026-02-10T10:20:00Z', contentLines: ['Cảm ơn chia sẻ, phần đặt lịch thực sự rất quan trọng.'] }
                ]
            },
            2: {
                title: 'Làm sao cân bằng học Master và việc part-time?',
                categoryId: 3,
                authorName: 'Hoàng Nam',
                createdAt: '2026-02-12T14:00:00Z',
                contentLines: [
                    'Mình đang học M1 và làm part-time 20h/tuần, cảm giác khá quá tải ở giai đoạn giữa kỳ.',
                    'Không biết mọi người thường chia thời khóa biểu như thế nào để giữ hiệu quả học tập?'
                ],
                comments: [
                    { id: 1, authorName: 'Thùy Dương', createdAt: '2026-02-12T15:05:00Z', contentLines: ['Bạn nên chia block học theo tuần và cố định lịch làm để giảm xung đột.'] }
                ]
            }
        };

        const breadcrumbEl = document.getElementById('thread-breadcrumb');
        const categoryEl = document.getElementById('thread-category');
        const createdEl = document.getElementById('thread-created');
        const viewsEl = document.getElementById('thread-views');
        const repliesEl = document.getElementById('thread-replies');
        const titleEl = document.getElementById('thread-title');
        const authorEl = document.getElementById('thread-author');
        const tagsEl = document.getElementById('thread-tags');
        const postsCountEl = document.getElementById('posts-count');
        const statusEl = document.getElementById('thread-status');
        const postsEl = document.getElementById('thread-posts');
        const kpisEl = document.getElementById('thread-kpis');
        const relatedEl = document.getElementById('related-list');

        const replyForm = document.getElementById('reply-form');
        const replyNameEl = document.getElementById('reply-name');
        const replyEmailEl = document.getElementById('reply-email');
        const replyMessageEl = document.getElementById('reply-message');
        const replyCharCountEl = document.getElementById('reply-char-count');
        const replyFeedbackEl = document.getElementById('reply-feedback');
        const replyClearBtn = document.getElementById('reply-clear');
        const scrollReplyBtn = document.getElementById('btn-scroll-reply');

        if (!breadcrumbEl || !categoryEl || !createdEl || !viewsEl || !repliesEl || !titleEl || !authorEl || !tagsEl || !postsCountEl || !statusEl || !postsEl || !kpisEl || !relatedEl || !replyForm || !replyNameEl || !replyEmailEl || !replyMessageEl || !replyCharCountEl || !replyFeedbackEl || !replyClearBtn || !scrollReplyBtn) {
            return;
        }

        const escapeHtml = (value) => String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');

        const toMillis = (value) => {
            const time = Date.parse(String(value || ''));
            return Number.isFinite(time) ? time : 0;
        };

        const toCommentId = (value) => {
            const id = Number(value);
            return Number.isFinite(id) ? id : 0;
        };

        const sortRepliesByTime = (items) => {
            return items
                .map((item, index) => ({ item, index }))
                .sort((left, right) => {
                    const leftTime = toMillis(left.item?.createdAt);
                    const rightTime = toMillis(right.item?.createdAt);
                    if (leftTime && rightTime && leftTime !== rightTime) {
                        return leftTime - rightTime;
                    }
                    if (leftTime && !rightTime) return -1;
                    if (!leftTime && rightTime) return 1;
                    const idDiff = toCommentId(left.item?.id) - toCommentId(right.item?.id);
                    if (idDiff !== 0) return idDiff;
                    return left.index - right.index;
                })
                .map((entry) => entry.item);
        };

        const formatDateTime = (value) => {
            const time = toMillis(value);
            if (!time) return 'Không rõ thời gian';
            return new Intl.DateTimeFormat('vi-VN', {
                dateStyle: 'medium',
                timeStyle: 'short'
            }).format(new Date(time));
        };

        const timeAgo = (value) => {
            const time = toMillis(value);
            if (!time) return 'Không rõ';
            const diffMinutes = Math.max(0, Math.floor((Date.now() - time) / 60000));
            if (diffMinutes < 1) return 'Vừa xong';
            if (diffMinutes < 60) return `${diffMinutes} phút trước`;
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours} giờ trước`;
            return `${Math.floor(diffHours / 24)} ngày trước`;
        };

        const htmlToLines = (html) => {
            const normalized = String(html || '')
                .replace(/<\s*br\s*\/?\s*>/gi, '\n')
                .replace(/<\s*\/\s*(p|div|h[1-6]|li|blockquote)\s*>/gi, '\n')
                .replace(/<li[^>]*>/gi, '- ')
                .replace(/<[^>]+>/g, ' ')
                .replace(/&nbsp;/gi, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            const lines = normalized.split(/\n+/).map((line) => line.trim()).filter(Boolean);
            return lines.length ? lines : ['Nội dung đang được cập nhật.'];
        };

        const getInitial = (name) => {
            const value = String(name || '?').trim();
            return value ? value.charAt(0).toUpperCase() : '?';
        };

        const getRequestedThread = () => {
            const params = new URLSearchParams(window.location.search);
            const postId = Number(params.get('postId') || 0);
            if (Number.isInteger(postId) && postId > 0) {
                return { postId, topicFallback: null };
            }
            const topic = Number(params.get('topic') || 0);
            if (Number.isInteger(topic) && topic > 0) {
                return { postId: topic, topicFallback: topic };
            }
            return { postId: 0, topicFallback: null };
        };

        const loadMetricStore = () => {
            try {
                const parsed = JSON.parse(localStorage.getItem(METRIC_KEY) || '{}');
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch (_) {
                return {};
            }
        };

        const saveMetricStore = (store) => {
            try {
                localStorage.setItem(METRIC_KEY, JSON.stringify(store));
            } catch (_) {
            }
        };

        const metricStore = loadMetricStore();

        const updateThreadMetrics = (threadId, updater) => {
            const key = String(threadId);
            const current = metricStore[key] && typeof metricStore[key] === 'object'
                ? metricStore[key]
                : { views: 0, replies: 0, lastCommentAt: '' };
            const next = updater({
                views: Number(current.views || 0),
                replies: Number(current.replies || 0),
                lastCommentAt: String(current.lastCommentAt || '')
            });
            metricStore[key] = {
                views: Math.max(0, Math.floor(Number(next.views || 0))),
                replies: Math.max(0, Math.floor(Number(next.replies || 0))),
                lastCommentAt: String(next.lastCommentAt || '')
            };
            saveMetricStore(metricStore);
            return metricStore[key];
        };

        const getThreadMetrics = (threadId) => {
            const key = String(threadId);
            const raw = metricStore[key] && typeof metricStore[key] === 'object' ? metricStore[key] : {};
            return {
                views: Math.max(0, Math.floor(Number(raw.views || 0))),
                replies: Math.max(0, Math.floor(Number(raw.replies || 0))),
                lastCommentAt: String(raw.lastCommentAt || '')
            };
        };

        const localReplyKey = (threadId) => `${LOCAL_REPLY_PREFIX}${threadId}`;

        const loadLocalReplies = (threadId) => {
            try {
                const parsed = JSON.parse(localStorage.getItem(localReplyKey(threadId)) || '[]');
                return sortRepliesByTime(Array.isArray(parsed) ? parsed : []);
            } catch (_) {
                return [];
            }
        };

        const saveLocalReplies = (threadId, replies) => {
            try {
                localStorage.setItem(localReplyKey(threadId), JSON.stringify(replies));
            } catch (_) {
            }
        };

        const normalizeApiThread = (payload) => {
            const post = payload && payload.post && typeof payload.post === 'object' ? payload.post : payload;
            const comments = Array.isArray(payload && payload.comments) ? payload.comments : [];
            const author = post?.author || {};
            return {
                threadId: Number(post?.postId || 0),
                title: String(post?.title || 'Chủ đề'),
                categoryId: Number(post?.categoryId || 0),
                authorName: String(author.displayName || author.nickname || 'Thành viên SVP'),
                createdAt: String(post?.createdAt || ''),
                updatedAt: String(post?.updatedAt || post?.createdAt || ''),
                contentLines: htmlToLines(post?.contentHtml || ''),
                comments: comments.map((comment) => {
                    const commentAuthor = comment?.author || {};
                    return {
                        id: Number(comment?.commentId || Date.now()),
                        authorName: String(commentAuthor.displayName || commentAuthor.nickname || 'Thành viên'),
                        createdAt: String(comment?.createdAt || ''),
                        contentLines: htmlToLines(comment?.contentHtml || '')
                    };
                })
            };
        };

        const buildFallbackThread = (topicId) => {
            const fallback = FALLBACK_TOPICS[topicId];
            if (!fallback) return null;
            return {
                threadId: topicId,
                title: fallback.title,
                categoryId: fallback.categoryId,
                authorName: fallback.authorName,
                createdAt: fallback.createdAt,
                updatedAt: fallback.createdAt,
                contentLines: fallback.contentLines,
                comments: fallback.comments
            };
        };

        const renderHeader = (thread, metrics, totalReplies) => {
            const categoryName = CATEGORY_MAP.get(thread.categoryId) || `Chuyên mục #${thread.categoryId || '?'}`;
            const createdLabel = formatDateTime(thread.createdAt);
            breadcrumbEl.textContent = thread.title;
            categoryEl.textContent = categoryName;
            createdEl.textContent = createdLabel;
            viewsEl.textContent = `${metrics.views} lượt xem`;
            repliesEl.textContent = `${totalReplies} phản hồi`;
            titleEl.textContent = thread.title;
            authorEl.textContent = `Khởi tạo bởi ${thread.authorName}`;
            tagsEl.innerHTML = `<span class="sv-tag">${escapeHtml(categoryName)}</span><span class="sv-tag">${escapeHtml(timeAgo(thread.updatedAt || thread.createdAt))}</span>`;
        };

        const toPostItem = (post, index, isOriginalPost) => {
            return {
                index,
                isOriginalPost,
                authorName: post.authorName,
                role: isOriginalPost ? 'Chủ thớt' : 'Thành viên',
                createdAt: post.createdAt,
                lines: Array.isArray(post.contentLines) && post.contentLines.length ? post.contentLines : ['Nội dung đang cập nhật.']
            };
        };

        const renderPosts = (thread, apiComments, localReplies) => {
            const orderedReplies = sortRepliesByTime([...apiComments, ...localReplies]);
            const postItems = [
                toPostItem(thread, 1, true),
                ...orderedReplies.map((item, idx) => toPostItem(item, idx + 2, false))
            ];

            postsCountEl.textContent = `${postItems.length} bài`;
            statusEl.style.display = 'none';

            postsEl.innerHTML = postItems.map((item) => `
                <article class="sv-thread-post">
                    <aside class="sv-thread-post__author">
                        <div class="sv-thread-post__avatar">${escapeHtml(getInitial(item.authorName))}</div>
                        <div class="sv-thread-post__name">${escapeHtml(item.authorName)}</div>
                        <div class="sv-thread-post__role">${escapeHtml(item.role)}</div>
                    </aside>
                    <div class="sv-thread-post__body">
                        <div class="sv-thread-post__meta">
                            <span>${escapeHtml(formatDateTime(item.createdAt))}</span>
                            <span>#${item.index}</span>
                        </div>
                        <div class="sv-thread-post__content">
                            ${item.lines.map((line) => `<p>${escapeHtml(line)}</p>`).join('')}
                        </div>
                        <div class="sv-thread-post__actions">
                            <button type="button" data-reply="${escapeHtml(item.authorName)}">Trả lời</button>
                            <button type="button" data-quote="${escapeHtml(item.lines[0] || '')}">Trích dẫn</button>
                        </div>
                    </div>
                </article>
            `).join('');
        };

        const renderThreadKpis = (thread, metrics, totalPosts, totalReplies) => {
            kpisEl.innerHTML = `
                <li><div><strong>ID thread</strong><div class="sv-meta">#${thread.threadId}</div></div></li>
                <li><div><strong>Bài viết trong thread</strong><div class="sv-meta">${totalPosts} bài</div></div></li>
                <li><div><strong>Phản hồi</strong><div class="sv-meta">${totalReplies} phản hồi</div></div></li>
                <li><div><strong>Lượt xem</strong><div class="sv-meta">${metrics.views} lượt xem</div></div></li>
                <li><div><strong>Hoạt động gần nhất</strong><div class="sv-meta">${escapeHtml(metrics.lastCommentAt ? formatDateTime(metrics.lastCommentAt) : formatDateTime(thread.updatedAt || thread.createdAt))}</div></div></li>
            `;
        };

        const renderRelatedThreads = async (threadId, categoryId) => {
            relatedEl.innerHTML = '<li><div class="sv-meta">Đang tải chủ đề liên quan...</div></li>';
            try {
                const response = await fetch(`${API_BASE_URL}/posts/latest-discussions?limit=8&categoryId=${encodeURIComponent(categoryId)}`, {
                    method: 'GET',
                    headers: { Accept: 'application/json' }
                });
                const payload = await response.json().catch(() => ({}));
                if (!response.ok) {
                    throw new Error(payload.error || 'Không thể tải chủ đề liên quan.');
                }
                const items = Array.isArray(payload.items) ? payload.items : [];
                const normalized = items
                    .map((item) => ({
                        postId: Number(item?.postId || 0),
                        title: String(item?.title || 'Chủ đề'),
                        createdAt: String(item?.createdAt || '')
                    }))
                    .filter((item) => item.postId > 0 && item.postId !== threadId)
                    .slice(0, 5);

                if (!normalized.length) {
                    relatedEl.innerHTML = '<li><div class="sv-meta">Chưa có chủ đề liên quan trong chuyên mục này.</div></li>';
                    return;
                }

                relatedEl.innerHTML = normalized.map((item) => `
                    <li>
                        <div>
                            <a href="thread.html?postId=${encodeURIComponent(item.postId)}">${escapeHtml(item.title)}</a>
                            <div class="sv-meta">${escapeHtml(timeAgo(item.createdAt))}</div>
                        </div>
                    </li>
                `).join('');
            } catch (error) {
                console.error('Cannot load related threads:', error);
                relatedEl.innerHTML = '<li><div class="sv-meta">Không tải được chủ đề liên quan.</div></li>';
            }
        };

        const setReplyFeedback = (text, type) => {
            replyFeedbackEl.textContent = text || '';
            replyFeedbackEl.style.color = type === 'error' ? '#b91c1c' : (type === 'success' ? '#15803d' : '#64748b');
        };

        const attachInteractionHandlers = () => {
            replyMessageEl.addEventListener('input', () => {
                replyCharCountEl.textContent = `${replyMessageEl.value.length}/2000 ký tự`;
            });

            replyClearBtn.addEventListener('click', () => {
                replyForm.reset();
                replyCharCountEl.textContent = '0/2000 ký tự';
                setReplyFeedback('', 'info');
            });

            scrollReplyBtn.addEventListener('click', () => {
                document.getElementById('reply-box').scrollIntoView({ behavior: 'smooth', block: 'start' });
                replyMessageEl.focus();
            });

            postsEl.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLButtonElement)) return;
                const replyTo = String(target.dataset.reply || '').trim();
                if (replyTo) {
                    const prefix = `@${replyTo} `;
                    if (!replyMessageEl.value.startsWith(prefix)) {
                        replyMessageEl.value = `${prefix}${replyMessageEl.value}`;
                    }
                    replyCharCountEl.textContent = `${replyMessageEl.value.length}/2000 ký tự`;
                    document.getElementById('reply-box').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    replyMessageEl.focus();
                    return;
                }
                const quote = String(target.dataset.quote || '').trim();
                if (quote) {
                    const quoted = `> ${quote}\n`;
                    replyMessageEl.value = `${quoted}${replyMessageEl.value}`.trim();
                    replyCharCountEl.textContent = `${replyMessageEl.value.length}/2000 ký tự`;
                    replyMessageEl.focus();
                }
            });
        };

        const loadUserPrefill = () => {
            const nickname = String(localStorage.getItem('userNickname') || '').trim();
            const email = String(localStorage.getItem('userEmail') || '').trim();
            if (nickname) replyNameEl.value = nickname;
            if (email) replyEmailEl.value = email;
        };

        const loadThread = async () => {
            const { postId, topicFallback } = getRequestedThread();
            if (!postId) {
                statusEl.textContent = 'Thiếu postId. Hãy quay lại danh sách forum và chọn một chủ đề.';
                return null;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/posts/${postId}`, {
                    method: 'GET',
                    headers: { Accept: 'application/json' }
                });
                const payload = await response.json().catch(() => ({}));
                if (!response.ok) {
                    throw new Error(payload.error || 'Không tìm thấy chủ đề.');
                }
                return normalizeApiThread(payload);
            } catch (error) {
                console.warn('Cannot load thread from API, trying fallback:', error);
                if (topicFallback && FALLBACK_TOPICS[topicFallback]) {
                    return buildFallbackThread(topicFallback);
                }

                let localArticle = null;
                try {
                    localArticle = JSON.parse(localStorage.getItem('svp.latestSubmittedArticle') || 'null');
                } catch (_) {
                    localArticle = null;
                }
                const localPostId = Number(localArticle?.postId || 0);
                if (localArticle && localPostId === postId) {
                    return {
                        threadId: localPostId,
                        title: String(localArticle.title || 'Chủ đề mới'),
                        categoryId: Number(localArticle.categoryId || 0),
                        authorName: String(localArticle?.author?.displayName || localArticle?.author?.nickname || 'Bạn'),
                        createdAt: String(localArticle.createdAt || new Date().toISOString()),
                        updatedAt: String(localArticle.createdAt || new Date().toISOString()),
                        contentLines: htmlToLines(localArticle.contentHtml || ''),
                        comments: []
                    };
                }
                throw error;
            }
        };

        const init = async () => {
            attachInteractionHandlers();
            loadUserPrefill();

            let thread;
            try {
                thread = await loadThread();
            } catch (_) {
                statusEl.textContent = 'Không thể tải chủ đề này. Hãy quay lại trang forum để chọn chủ đề khác.';
                return;
            }
            if (!thread) {
                return;
            }

            const localReplies = loadLocalReplies(thread.threadId);
            const apiComments = Array.isArray(thread.comments) ? thread.comments : [];
            const totalReplies = apiComments.length + localReplies.length;

            const metrics = updateThreadMetrics(thread.threadId, (prev) => ({
                views: prev.views + 1,
                replies: Math.max(prev.replies, totalReplies),
                lastCommentAt: prev.lastCommentAt || thread.updatedAt || thread.createdAt
            }));

            renderHeader(thread, metrics, totalReplies);
            renderPosts(thread, apiComments, localReplies);
            renderThreadKpis(thread, metrics, 1 + totalReplies, totalReplies);
            renderRelatedThreads(thread.threadId, thread.categoryId);

            replyForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const name = String(replyNameEl.value || '').trim();
                const email = String(replyEmailEl.value || '').trim();
                const message = String(replyMessageEl.value || '').trim();

                if (name.length < 2) {
                    setReplyFeedback('Tên hiển thị cần tối thiểu 2 ký tự.', 'error');
                    replyNameEl.focus();
                    return;
                }
                if (!/^[^\s@]+@[^\s@]+$/.test(email)) {
                    setReplyFeedback('Email chưa hợp lệ.', 'error');
                    replyEmailEl.focus();
                    return;
                }
                if (message.length < 5) {
                    setReplyFeedback('Nội dung phản hồi cần tối thiểu 5 ký tự.', 'error');
                    replyMessageEl.focus();
                    return;
                }

                const createdAt = new Date().toISOString();
                const newReply = {
                    id: Date.now(),
                    authorName: name,
                    createdAt,
                    contentLines: htmlToLines(message)
                };

                const currentReplies = loadLocalReplies(thread.threadId);
                currentReplies.push(newReply);
                saveLocalReplies(thread.threadId, currentReplies);

                const nextTotalReplies = apiComments.length + currentReplies.length;
                const nextMetrics = updateThreadMetrics(thread.threadId, (prev) => ({
                    views: prev.views,
                    replies: Math.max(prev.replies, nextTotalReplies),
                    lastCommentAt: createdAt
                }));

                localStorage.setItem('userEmail', email);
                if (!localStorage.getItem('userNickname')) {
                    localStorage.setItem('userNickname', name);
                }

                renderHeader(thread, nextMetrics, nextTotalReplies);
                renderPosts(thread, apiComments, currentReplies);
                renderThreadKpis(thread, nextMetrics, 1 + nextTotalReplies, nextTotalReplies);

                replyMessageEl.value = '';
                replyCharCountEl.textContent = '0/2000 ký tự';
                setReplyFeedback('Đã đăng phản hồi thành công (lưu cục bộ trên trình duyệt).', 'success');
            });
        };

        init();
    })();
</script>
<script src="auth-topbar.js"></script>
</body>
</html>


